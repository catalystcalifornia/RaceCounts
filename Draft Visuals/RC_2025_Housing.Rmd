---
title: "RACE COUNTS: Housing"
author: "Authored by: Catalyst California"
date: "8/25/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r include = FALSE}
### install version 1.1.1 of Crosstalk -- LATER VERSIONS OF CROSSTALK WILL NOT WORK ####
# remotes::install_version("crosstalk", version = "1.1.1", repos = "http://cran.us.r-project.org") 
# library(crosstalk)

#Set up workspace
packages <- c("crosstalk", "RPostgres", "sf", "htmltools", "tidyr", "reshape2", "plotly", "tidyverse", "highcharter")  

install_packages <- packages[!(packages %in% installed.packages()[,"Package"])] 

if(length(install_packages) > 0) { 
  install.packages(install_packages) 
  
} else { 
  
  print("All required packages are already installed.") 
} 

for(pkg in packages){ 
  library(pkg, character.only = TRUE) 
} 
options(scipen=999)

```


```{r setup, include = FALSE}

knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

#setwd("W:/Project/RACE COUNTS/2025_v7/Visualizations")

# data setup
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("racecounts")

source("W:\\RDA Team\\R\\credentials_source.R")
con2 <- connect_to_db("rda_shared_data")


# just a note of reference to inserting text #https://monashbioinformaticsplatform.github.io/2017-11-16-open-science-training/topics/rmarkdown.html
#https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf


```


```{r echo=FALSE, include = FALSE}

##Add RC theme##
rc_theme <- hc_theme(
    # race counts colors
  colors = c("orange", "purple", "red", "yellow"),
  chart = list(
    backgroundColor = "#FFFFFF",
    borderColor = "black",
    style = list(
          fontFamily = "Rubik") 
  ),
  title = list(
    style = list(
      color = "#070024",
      fontFamily = "Rubik")
  ),
  subtitle = list(
    style = list(
      color = "#8E8C8F", # medium grey
      fontFamily = "Rubik")
  ),
  caption = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
    axis = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
  legend = list(
    itemStyle = list(
      fontFamily = "Rubik",
      color = "#070024"),
    itemHoverStyle = list(
       fontFamily = "Rubik",
      color = "#070024")
  ))


lang <- getOption("highcharter.lang")
lang$thousandsSep <- ","
options(highcharter.lang = lang)

####################### ADD COUNTY DATA #####################################

c_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_cost_burden_owner_county_2025"))
c_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_cost_burden_renter_county_2025"))
c_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_denied_mortgages_county_2025"))
c_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_eviction_filing_rate_county_2025"))
c_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_foreclosure_county_2025"))
c_6 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_homeownership_county_2025"))
c_7 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_overcrowded_county_2025"))
c_8 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_housing_quality_county_2025"))
c_9 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_student_homelessness_county_2025"))
c_10 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_subprime_county_2025"))

c_index_z <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_index_2025"))


####################### POPULATION DATA #####################################
#Join total population to index view, housing cost burden for renters, and foreclosure data frames
pop <- dbGetQuery(con2, paste0("SELECT geoid, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_2023"))

c_index_z <- left_join(x = c_index_z, y = pop, by = c("county_id" = "geoid"))

c_1 <- left_join(x = c_1, y = pop, by = c("county_id" = "geoid")) # owners
c_2 <- left_join(x = c_2, y = pop, by = c("county_id" = "geoid")) # renters
c_3 <- left_join(x = c_3, y = pop, by = c("county_id" = "geoid")) # denied
c_5 <- left_join(x = c_5, y = pop, by = c("county_id" = "geoid")) # foreclosure
c_8 <- left_join(x = c_8, y = pop, by = c("county_id" = "geoid")) # quality
c_10 <- left_join(x = c_10, y = pop, by = c("county_id" = "geoid")) # subprime


####################### ADD STATE DATA #####################################
s_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_cost_burden_owner_state_2025"))
s_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_cost_burden_renter_state_2025"))
s_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_denied_mortgages_state_2025"))
s_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_eviction_filing_rate_state_2025"))
s_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_foreclosure_state_2025"))
s_6 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_homeownership_state_2025"))
s_7 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_overcrowded_state_2025"))
s_8 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_housing_quality_state_2025"))
s_9 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_student_homelessness_state_2025"))
s_10 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_hous_subprime_state_2025"))

##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_indicator_list_cntyst"))

```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>PERFORMANCE: How well people are doing. The higher the circle, the better the performance.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.

# Key Findings

# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Two or More Races.

# Indicators

## Housing Index
```{r}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
 c_index_chart <- c_index_z %>% mutate(
    disp_z_cap = case_when(
      housing_disparity_z > 2 ~ 2,
      housing_disparity_z < -2 ~ -2,
      TRUE ~ housing_disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      housing_performance_z > 2 ~ 2,
      housing_performance_z < -2 ~ -2,
      TRUE ~ housing_performance_z)
    ) %>% filter(housing_quadrant %in% c("yellow", "orange", "red", "purple"))

 c_index_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=housing_quadrant, ),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.housing_performance_rank} <br><strong>Disparity Rank: </strong>{point.housing_disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f}")) %>%
  hc_title(text = "Housing Index") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 2, min = -2) %>%     ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 2, min = -2) %>%   ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_caption(
    text = "Data source: Various <br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes.",
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* All but one of the Bay Area county have above average outcomes. Disparity levels vary, with San Mateo, Marin, Alameda, Napa, and San Francisco among the top ten most disparate counties in the state.
* All six Southern California counties have below average performance, although 4 out 6, including Los Angeles and San Diego counties, also have below average disparities.
* Looking across all Housing indicators, Latinx Californians had worse than average outcomes in all 10 housing indicators, while Black and American Indian / Alaskan Native residents had the worst rate in 4 out of 10 and 3 out of 10 indicators respectively. 


## Housing Cost Burden (Owner) {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_1_chart <- c_1 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

 c_1_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.nh_other_rate:.1f}")) %>%
  hc_title(text = "Households Experiencing Cost Burden (Owner) (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Housing Cost Burden (Owner)"]), 
    "<br>Comprehensive Housing Affordability Strategy (CHAS) data (2014-2018).", 
    "<br>Number of owner-occupied housing units where occupant spends more than 30% of income",
    "<br> on housing and related costs, out of all owner-occupied housing units.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* Counties with larger populations tend to have lower racial disparity and lower performance.

* Los Angeles has the fourth lowest racial disparity and the third worst cost burden for homeowners in the state.

* Seven out of eight counties in the San Joaquin Valley region have above average performance on homeowner cost burden rate.

### State Barchart
```{r}
# View(s_1)
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Households Experiencing Cost Burden (Owner) (%)"
s_1_ <- s_1 %>%
     select(c(state_name, ends_with('_rate'), -total_rate)) 
s_1_long <- melt(s_1_, id.vars=c("state_name"))
s_1_long <- s_1_long[order(s_1_long$value),]
s_1_long <- s_1_long %>% mutate_if(is.double, ~round(., 1))

s_1_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_1$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_1$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


``` 
* Nearly one in three California homeowners is housing cost burdened, spending 30% or more of income on housing.
* Statewide, Latinx and Black homeowners have the highest housing cost burden rate, at 3% and 7% above the statewide rate respectively.
* The housing cost burden rate for Black homeowners is 10 percentage points higher than it is for the group with the best rate, American Indian or Alaska Native homeowners.

### County Barchart

```{r}

c_1_long <- c_1 %>%
   select(c(2, ends_with('_rate')))

c_1_long <- melt(c_1_long, id.vars=c("county_name"))
c_1_long <- c_1_long[order(c_1_long$value),]
# Round 'value' field to 1 decimal
c_1_long <- c_1_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_1_long, key = ~ county_name)
title = "Households Experiencing Cost Burden (Owner) (%)"

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols



```


## Housing Cost Burden (Renter) {.tabset .tabset-fade}

### Scatterplot

```{r}
c_2_chart <- c_2 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_2_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.nh_other_rate:.1f}")) %>%
    hc_title(text = "Households Experiencing Cost Burden (Renter) (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Housing Cost Burden (Renter)"]), 
    "<br>Percentage of renter-occupied housing units where renter spends more than 30% of income", 
    "<br>on housing and related costs, out of all renter-occupied housing units.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```
* Orange, San Francisco, and Frenso Counties are the only three of the state's 10 most populous counties to have higher than average racial disparities in rent burden rates.
* Nine out of 10 of the worst performing counties in terms of rent burden are in the Northern / Sierra or Southern California regions.


### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Households Experiencing Cost Burden (Renter) (%)"
s_2_ <- s_2 %>%
     select(c(state_name, ends_with('_rate'), -total_rate)) 
s_2_long <- melt(s_2_, id.vars=c("state_name"))
s_2_long <- s_2_long[order(s_2_long$value),]
s_2_long <- s_2_long %>% mutate_if(is.double, ~round(., 1))

s_2_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_2$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_2$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)
```
* Over half of all renters in California are burdened by housing costs
* Black and Latinx Californians are the only racial groups where over half of renters are housing cost burdened

### County Barchart

```{r}

c_2_long <- c_2 %>%
   select(c(2, ends_with('_rate')))

c_2_long <- melt(c_2_long, id.vars=c("county_name"))
c_2_long <- c_2_long[order(c_2_long$value),]
# Round 'value' field to 1 decimal
c_2_long <- c_2_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_2_long, key = ~ county_name)
title = 'Households Experiencing Cost Burden<br>(Renter) (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

```


## Denied Mortgage Applications {.tabset .tabset-fade}

### Scatterplot

```{r}

c_3_chart <- c_3 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_3_chart %>%
    hchart("scatter",
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant), #total_originated
      tooltip =
         list(pointFormat =
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Denied Mortgage Applications (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>%
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>%
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Denied Mortgage Applications"]), 
    "<br>Mortgage applications were for purchases of one-to-four family dwellings.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>%
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* Counties with larger populations tend to have lower disparity and above average performance in denied mortgage applications.
* Eight out of the ten worst performing counties in mortgage denial rates also have above average racial disparities in application denials.
* Imperial County and Amador County have the highest levels of racial disparity in the state by a substantial margin. In both counties, more than 42% of Black applicants and American Indian or Alaska Native applicants are denied mortgages.


### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Denied Mortgage Applications (%)"

s_3_ <- s_3 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_3_long <- melt(s_3_, id.vars=c("state_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of s_3_long$value when MAX is best.
s_3_long <- s_3_long[order(s_3_long$value),]
# Round 'value' field to 1 decimal
s_3_long <- s_3_long %>% mutate_if(is.double, ~round(., 1))

s_3_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_3$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_3$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)
``` 
* Statewide, American Indian and Alaska Native Californians have the worst mortgage application rate of any racial group and are denied on over 30% of mortgage applications. This is almost double the overall denial rate in the state.
* Black, Pacific Islander, and Latinx Californians are also all over 5 percentage points more likely to have a mortgage application denied than the average Californian.


### County Barchart

```{r}
c_3_long <- c_3 %>%
   select(c(2, ends_with('_rate')))

c_3_long <- melt(c_3_long, id.vars=c("county_name"))
c_3_long <- c_3_long[order(c_3_long$value),]
# Round 'value' field to 1 decimal
c_3_long <- c_3_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_3_long, key = ~ county_name)
title = 'Denied Mortgage Applications (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Eviction {.tabset .tabset-fade}

### Scatterplot

```{r}
c_4_chart <- c_4 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_4_chart %>%
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.other_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.twoormor_rate:.1f}")) %>%
  hc_title(text = "Eviction Filing Rate per 100 Renter Households") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Evictions"]), 
    "<br>Rate of eviction filings per 100 renter households in relation to racial population residing in the area.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* San Bernardino County has the highest overall eviction filing rate (worst performance), with higher rates for all groups (lower disparity).
* Five of the ten most disparate counties for evictions are in the Bay Area (San Francisco, Alameda, Contra Costa, San Mateo, and Santa Clara). However,these same five counties all have higher than average performance, meaning lower overall eviction rates.

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Eviction Filing Rate per 100 Renter Households"

s_4_ <- s_4 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_4_long <- melt(s_4_, id.vars=c("state_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of s_4_long$value when MAX is best.
s_4_long <- s_4_long[order(s_4_long$value),]
# Round 'value' field to 1 decimal
s_4_long <- s_4_long %>% mutate_if(is.double, ~round(., 1))

s_4_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_4$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_4$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

```
* Black households are nearly twice as likely to face eviction statewide as White or Asian households.
* Only Asian and non-Latinx White households have eviction filing rates better than the statewide average.


### County Barchart

```{r}
c_4_long <- c_4 %>%
   select(c(2, ends_with('_rate')))

c_4_long <- melt(c_4_long, id.vars=c("county_name"))
c_4_long <- c_4_long[order(c_4_long$value),]
# Round 'value' field to 1 decimal
c_4_long <- c_4_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_4_long, key = ~ county_name)
title = 'Eviction Filing Rate per 100 Renter Households'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Foreclosure {.tabset .tabset-fade}

### Scatterplot

```{r}
c_5_chart <- c_5 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_5_chart  %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.other_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.twoormor_rate:.1f}")) %>%
    hc_title(text = "Foreclosure Rate per 10k Owner-Occupied Housing Units") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Foreclosure"]), 
    "<br>Rate per 10,000 of Foreclosed Real Estate Owned Properties (REO) in relation to racial population residing in the area.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```

* Six out of the nine Bay Area counties are in the Purple Quadrant (High performance, Low disparity).
* Of the ten most populous counties in the state, eight better than average foreclosure rates and seven have low racial disparities within those rates.


### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Foreclosure Rate per 10k Owner-Occupied Housing Units"

s_5_ <- s_5 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_5_long <- melt(s_5_, id.vars=c("state_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of s_5_long$value when MAX is best.
s_5_long <- s_5_long[order(s_5_long$value),]
# Round 'value' field to 1 decimal
s_5_long <- s_5_long %>% mutate_if(is.double, ~round(., 1))

s_5_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_5$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_5$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)
 

```
* Black and AIAN foreclosure rates are over two times higher than the the group with the best (lowest) rate.
* White and Asian Californians are the only racial groups who have better foreclosure rates than the state average.

### County Barchart

```{r}
c_5_long <- c_5 %>%
   select(c(2, ends_with('_rate')))

c_5_long <- melt(c_5_long, id.vars=c("county_name"))
c_5_long <- c_5_long[order(c_5_long$value),]
# Round 'value' field to 1 decimal
c_5_long <- c_5_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_5_long, key = ~ county_name)
title = 'Foreclosure Rate per 10k Owner-Occupied Housing Units'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Homeownership {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_6_chart <- c_6 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_6_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.other_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.twoormor_rate:.1f}")) %>%
  hc_title(text = "Homeownership (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Homeownership"]), 
    "<br>Percentage of owner-occupied housing units out of all occupied units.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)
       
      


```
* Homeownership is more prevalent in counties with smaller populations, which makes sense as we would generally expect lower house prices in those counties.
* San Francisco, with the worst performance, is one of two counties where less than half of households own a home. It has the worst racial disparity statewide because the Asian homeownership rate is double, or close to double, that of all other groups.
* Los Angeles, with the second worst performance, is the other county where less than half of households own a home. It has an average level of racial disparity, but the statewide patterns hold, with non-Latinx White and Asian homeownership rates being higher than other groups.


### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Homeownership (%)"
s_6_ <- s_6 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_6_long <- melt(s_6_, id.vars=c("state_name"))
s_6_long <- s_6_long[order(-s_6_long$value),]
s_6_long <- s_6_long %>% mutate_if(is.double, ~round(., 1))

s_6_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_6$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_6$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

``` 
* White Californians are nearly twice as likely to own their home as Black Californians. Slightly more than one-third of Black households own their home.
* Statewide, less than half of American Indian or Alaska Native, Pacific Islander, Latinx, Black, or households identifying with a racial group under "other" own a home.


### County Barchart

```{r}
c_6_long <- c_6 %>%
   select(c(2, ends_with('_rate')))

c_6_long <- melt(c_6_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_6_long$value when MAX is best.
c_6_long <- c_6_long[order(c_6_long$value),]
# Round 'value' field to 1 decimal
c_6_long <- c_6_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_6_long, key = ~ county_name)
title = 'Homeownership (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),   # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols



```

## Overcrowded Housing {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_7_chart <- c_7 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_7_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.other_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.twoormor_rate:.1f}")) %>%
  hc_title(text = "Overcrowded Housing Units (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Overcrowded Housing"]), 
    "<br>Percentage of housing units with more than one person per room.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)
       
      


```
* Los Angeles ranks second in worst (performance) in Overcrowded Housing. All of the ten counties with the worst performance are in Southern California, Central Valley, or the Central Coast regions.
* Four of the ten counties with the worst disparity are in the Bay Area region, with  Marin County having by far the worst disparity in the state.
* Marin County has the highest disparity due to one in three Latinx households and more than one in two Other Race households living in overcrowded housing, while fewer than five out of every 100 non-Latinx White households do.


### State Barchart

```{r}

# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Overcrowded Housing Units (%)"

s_7_ <- s_7 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_7_long <- melt(s_7_, id.vars=c("state_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of s_7_long$value when MAX is best.
s_7_long <- s_7_long[order(s_7_long$value),]
# Round 'value' field to 1 decimal
s_7_long <- s_7_long %>% mutate_if(is.double, ~round(., 1))

s_7_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_7$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_7$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)
 


``` 
* Statewide, Black households have the second best rate of overcrowded housing and are about 33% less likely to live in overcrowded housing than the average Californian.
* The Latinx overcrowded housing rate is almost 16 percentage points higher than that of Non-Latinx White households.


### County Barchart

```{r}
c_7_long <- c_7 %>%
   select(c(2, ends_with('_rate')))

c_7_long <- melt(c_7_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_7_long$value when MAX is best.
c_7_long <- c_7_long[order(c_7_long$value),]
# Round 'value' field to 1 decimal
c_7_long <- c_7_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_7_long, key = ~ county_name)
title = 'Overcrowded Housing Units (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

```


## Housing Quality {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_8_chart <- c_8 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_8_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.nh_other_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
  hc_title(text = "Low Quality Housing (%)<br>(Lack of Available Kitchen, Plumbing, or Heat)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Housing Quality"]), 
    "<br>Percentage of housing units that lack kitchen, plumbing, or heat out of all housing units.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* San Francisco County has the worst performance (highest overall rate) of people living in low quality housing. Only non-Latinx White and Asian residents are less likely to have low quality housing rates below the average.
* Los Angeles County has the second worst performance and seventh worst disparity rankings on this measure. Latinx households face the worst racial disparities on this measure by far among all groups, with 12% living in low quality housing.


### State Barchart

```{r}

# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Low Quality Housing (%)<br>(Lack of Available Kitchen, Plumbing, or Heat)"

s_8_ <- s_8 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_8_long <- melt(s_8_, id.vars=c("state_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of s_8_long$value when MAX is best.
s_8_long <- s_8_long[order(s_8_long$value),]
# Round 'value' field to 1 decimal
s_8_long <- s_8_long %>% mutate_if(is.double, ~round(., 1))

s_8_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_8$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_8$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)
 


``` 
* Latinx Californians are over 2.5 times more likely to live in low quality housing as non-Latinx White Californians.
* American Indians and Alaskan Natives, Pacific Islanders and Californians identifying with the racial category "other"  the other three other racial groups with low quality housing rates that are worse than the state average.


### County Barchart

```{r}
c_8_long <- c_8 %>%
   select(c(2, ends_with('_rate')))

c_8_long <- melt(c_8_long, id.vars=c("county_name"))
c_8_long <- c_8_long[order(c_8_long$value),]
# Round 'value' field to 1 decimal
c_8_long <- c_8_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_8_long, key = ~ county_name)
title = 'Low Quality Housing (%)<br>(Lack of Available Kitchen, Plumbing, or Heat)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

```


## Student Homelessness {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_9_chart <- c_9 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_9_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>Filipinx Rate: </strong>{point.nh_filipino_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
  hc_title(text = "Students Experiencing Homelessness (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Student Homelessness"]), 
    "<br>Percentage of students experiencing homelessness out of all enrolled students.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)
      


```
* Four of the Five most racially disparate counties on this measure are in the Bay Area. Alameda, Santa Cruz, and San Mateo Counties in particular have by far the highest rates of racial disparity in student homelessness in the state.
* Three of the four counties that are struggling the worst with overall student homelessness rate are semi-urban counties in the Central Coast -- Santa Barbara, Monterey, and San Luis Obispo.


### State Barchart

```{r}

title = "Students Experiencing Homelessness (%)"

s_9_ <- s_9 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_9_long <- melt(s_9_, id.vars=c("state_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of s_9_long$value when MAX is best.
s_9_long <- s_9_long[order(s_9_long$value),]
# Round 'value' field to 1 decimal
s_9_long <- s_9_long %>% mutate_if(is.double, ~round(., 1))

s_9_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_9$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_9$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


``` 
* American Indian and Alaska Native Californians have the highest student homelessness rate in the state at 7.1%, which is a 75% increase over the statewide rate.
* Black, Latinx, and Pacific Islander students are all significantly above the statewide rate as well.
* Asian, Filipino, and White students in California all experience rates of student homelessness that are less than half of the overall statewide rate.

### County Barchart

```{r}
c_9_long <- c_9 %>%
   select(c(county_name, ends_with('_rate')))

c_9_long <- melt(c_9_long, id.vars=c("county_name"))
c_9_long <- c_9_long[order(c_9_long$value),]
# Round 'value' field to 1 decimal
c_9_long <- c_9_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_9_long, key = ~ county_name)
title = 'Students Experiencing Homelessness (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

```


## Subprime Mortgage Loans - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_10_chart <- c_10 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_10_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant), #total_pop
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f}  <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
  hc_title(text = "Subprime (Higher-priced) Loans per 1k Mortgage Loan Applicants") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Subprime Mortgage Loans"]), "<br>Number of higher-priced loans per 1,000 mortgage applications.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme) 


```
* Six out of the eight San Joaquin Valley counties are in the Yellow Quadrant (Lower Disparity, Lower Performance) meaning they have subprime loan rates and lower racial disparities.
* Seven out of the nine Bay Area counties are in the Orange Quadrant (Higher Disparity, Better Outcomes).


### State Barchart

```{r}

# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Subprime (Higher-priced) Loans per 1k Mortgage Loan Applicants"

s_10_ <- s_10 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_10_long <- melt(s_10_, id.vars=c("state_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of s_10_long$value when MAX is best.
s_10_long <- s_10_long[order(s_10_long$value),]
# Round 'value' field to 1 decimal
s_10_long <- s_10_long %>% mutate_if(is.double, ~round(., 1))

s_10_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_10$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_10$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)
 

``` 
* Lenders are more than four times as likely to give Latinx applicants a subprime mortgage than the group with the best (lowest) rate. 


### County Barchart

```{r}
c_10_long <- c_10 %>%
   select(c(2, ends_with('_rate')))

c_10_long <- melt(c_10_long, id.vars=c("county_name"))
c_10_long <- c_10_long[order(c_10_long$value),]
# Round 'value' field to 1 decimal
c_10_long <- c_10_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_10_long, key = ~ county_name)
title = 'Subprime (Higher-priced) Loans per 1k Mortgage Loan Applicants'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

```

```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-9) for a total of 10 graphs. If another graph is added, then you would simply add another line and label it as [11]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```

```{r echo=FALSE, include = FALSE}
# Closing connections

dbDisconnect(con)
dbDisconnect(con2)
```

```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[6].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[7].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[8].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[9].selectize.setValue("Alameda", false);
 }
window.onload = filter_default;
```




