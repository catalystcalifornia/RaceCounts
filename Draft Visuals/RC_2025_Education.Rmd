---
title: "RACE COUNTS: Education"
author: "Authored by: Catalyst California"
date: "8/25/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---

<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r include = FALSE}
### install version 1.1.1 of Crosstalk -- LATER VERSIONS OF CROSSTALK WILL NOT WORK ####
# remotes::install_version("crosstalk", version = "1.1.1", repos = "http://cran.us.r-project.org") 
# library(crosstalk)

#Set up workspace
packages <- c("crosstalk", "RPostgres", "sf", "htmltools", "tidyr", "reshape2", "plotly", "tidyverse", "highcharter")  

install_packages <- packages[!(packages %in% installed.packages()[,"Package"])] 

if(length(install_packages) > 0) { 
  install.packages(install_packages) 
  
} else { 
  
  print("All required packages are already installed.") 
} 

for(pkg in packages){ 
  library(pkg, character.only = TRUE) 
} 
options(scipen=999)

```


```{r setup, include = FALSE}

knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))


#setwd("W:/Project/RACE COUNTS/2025_v7/Visualizations")

# data setup
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("racecounts")

source("W:\\RDA Team\\R\\credentials_source.R")
con2 <- connect_to_db("rda_shared_data")


# just a note of reference to inserting text #https://monashbioinformaticsplatform.github.io/2017-11-16-open-science-training/topics/rmarkdown.html
#https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf

```


```{r echo=FALSE, include = FALSE}

##Add RC theme##
rc_theme <- hc_theme(
    # race counts colors
  colors = c("orange", "purple", "red", "yellow"),
  chart = list(
    backgroundColor = "#FFFFFF",
    borderColor = "black",
    style = list(
          fontFamily = "Rubik") 
  ),
  title = list(
    style = list(
      color = "#070024",
      fontFamily = "Rubik")
  ),
  subtitle = list(
    style = list(
      color = "#8E8C8F", # medium grey
      fontFamily = "Rubik")
  ),
  caption = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
    axis = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
  legend = list(
    itemStyle = list(
      fontFamily = "Rubik",
      color = "#070024"),
    itemHoverStyle = list(
       fontFamily = "Rubik",
      color = "#070024")
  ))


lang <- getOption("highcharter.lang")
lang$thousandsSep <- ","
options(highcharter.lang = lang)

####################### ADD COUNTY DATA #####################################

c_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_chronic_absenteeism_county_2025"))
c_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_hs_grad_county_2025"))
c_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_gr3_ela_scores_county_2025"))
c_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_gr3_math_scores_county_2025"))
c_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_suspension_county_2025"))
c_6 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_ece_access_county_2025"))
c_7 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_staff_diversity_county_2025"))

c_index_z <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_index_2025"))


####################### POPULATION DATA #####################################
#Join total population to index view, food access, and asthma data frames
pop <- dbGetQuery(con2, paste0("SELECT geoid, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_2023"))

#c_index_pctile <- left_join(x = c_index_pctile, y = pop, by = c("county_id" = "geoid"))
c_index_z <- left_join(x = c_index_z, y = pop, by = c("county_id" = "geoid"))


####################### ADD STATE DATA #####################################
s_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_chronic_absenteeism_state_2025"))
s_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_hs_grad_state_2025"))
s_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_gr3_ela_scores_state_2025"))
s_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_gr3_math_scores_state_2025"))
s_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_suspension_state_2025"))
s_6 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_ece_access_state_2025"))
s_7 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_educ_staff_diversity_state_2025"))

##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_indicator_list_cntyst"))

```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>PERFORMANCE: How well people are doing. The higher the circle, the better the performance.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.


# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Two or More Races.

# Key Findings

* There are several key areas where racial disparities exist in educational outcomes across different racial and ethnic groups in the state of California.

* Across the state, NH-AIAN, NH-Black, Latinx, and NH-Pacific Islander are more likely to experience chronic absenteeism than other groups. (See State Barchart on Chronically Absent Students (%))

* Additionally, NH-AIAN, NH-Black, Latinx, and NH-Pacific Islander students have lower graduation rates than the state average. NH-Black student graduation rates are 16.7 percentage points lower than the group with the highest rate. (See State Barchart on Graduates as a Percentage of Four-Year Adjusted Cohort Students)

* NH- Filipinx, NH- Asian, NH- White, and NH- Students of Two or More races experience lower suspension rates. (See State Barchart on students Suspended per 100 Students)

* More than 50% of Asian, Filipinx, Two or More Races, and White third graders scored proficient in English Language Arts, while less than a third of NH-PI, NH-Black, NH-AIAN, and Latinx students score proficient or better. (See State Barchart on 3rd Graders Scoring Proficient or Better in English Language Arts (%) and 3rd Graders Scoring Proficient or Better in Math (%))

* ECE access rates are low across the state for all groups, even the best rate means less than one in two children has acess to licensed ECE programs. Still NH-AIAN, Latinx, and NH-Black children all have less acccess to licensed ECE programs than the average child in California. (See State Barchart on Children 0-5 Enrolled in Licensed ECE Program (%))

# Indicators 

## Education Index - UPDATED
```{r}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
 c_index_chart <- c_index_z %>% mutate(
    disp_z_cap = case_when(
      education_disparity_z > 2 ~ 2,
      education_disparity_z < -2 ~ -2,
      TRUE ~ education_disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      education_performance_z > 2 ~ 2,
      education_performance_z < -2 ~ -2,
      TRUE ~ education_performance_z)
    ) %>% filter(education_quadrant %in% c("yellow", "orange", "red", "purple"))

 c_index_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=education_quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.education_performance_rank} <br><strong>Disparity Rank: </strong>{point.education_disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f}")) %>%
  hc_title(text = "Education Index") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 2, min = -2) %>%     ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 2, min = -2) %>%   ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_caption(
    text = "Data source: Various <br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes.",
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>%  hc_add_theme(rc_theme)


```

* San Francisco has among the highest racial disparities, driven by large inequities in chronic absenteeism and graduation rates.

* Most Northern California region counties have lower than average performance, with many counties also exhibiting higher levels of disparity. 




## Chronic Absenteeism - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}

# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_1_chart <- c_1 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

 c_1_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Filipinx Rate: </strong>{point.nh_filipino_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
  hc_title(text = "Chronically Absent Students per 100 Students") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Chronic Absenteeism"]), 
    "<br> A chronically absent student is absent on 10 percent or more of school days per year.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* San Francisco County is by far the most racially disparate on chronic absenteeism. NHPI students have the highest absenteeism rate at 65.9%, which is  58.2 percentage points higher than the group with the lowest rate.

* Plumas County has the highest rates of absenteeism, with more than half of students (56.2%) being chronically absent. All groups have higher rates, however, Latinx students are the most likely to be chronically absent (61.8%).

### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Chronically Absent Students (%)"

s_1_ <- s_1 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_1_long <- melt(s_1_, id.vars=c("state_name"))
s_1_long <- s_1_long[order(s_1_long$value),]
s_1_long <- s_1_long %>% mutate_if(is.double, ~round(., 1))

s_1_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_1$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_1$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

``` 
* Statewide, NHPI, NH-Black, NH-AIAN, and Latinx students have the highest rates for chronic absenteeism ranging from 28.9% to 36.6% respectively. 

* NH-Black, NHPI, and NH-AIAN students are 3.5 times more likely to be chronically absent than the group with the lowest rate.

### County Barchart

```{r}
c_1_long <- c_1 %>%
   select(c(2, ends_with('_rate')))

c_1_long <- melt(c_1_long, id.vars=c("county_name"))
# Round 'value' field to 1 decimal
c_1_long <- c_1_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_1_long, key = ~ county_name)
title = "Chronically Absent Students (%)"

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"),
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## High School Graduation - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_2_chart <- c_2 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_2_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Filipinx Rate: </strong>{point.nh_filipino_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Graduates as a Percentage of Four-Year Adjusted Cohort Students") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "High School Graduation"]), 
    "<br> Graduates are students who graduate with either a traditional high school diploma,",
    "<br>an adult education high school diploma, or have passed the California High School Proficiency Exam.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```
* Mono, Nevada, Inyo, and San Francisco Counties have the lowest graduation rates and the highest racial disparities on this measure. 

* In Mono, only one in three Latinx students graduate.

### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3

title = "Graduates as a Percentage of Four-Year Adjusted Cohort Students"
s_2_ <- s_2 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_2_long <- melt(s_2_, id.vars=c("state_name"))
s_2_long <- s_2_long[order(-s_2_long$value),]
s_2_long <- s_2_long %>% mutate_if(is.double, ~round(., 1))

s_2_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_2$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_2$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

```
* NH-AIAN, NH-Black, Latinx, and NH-PI students have below average graduation rates. Black and NH-AIAN student graduation rates are roughly 16 percentage points lower than the group with the highest rate.

### County Barchart

```{r}
c_2_long <- c_2 %>%
   select(c(2, ends_with('_rate'))) ##Value of 1 gives us county_id, value of 2 gives us county_name

c_2_long <- melt(c_2_long, id.vars=c("county_name"))
# Round 'value' field to 1 decimal
c_2_long <- c_2_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_2_long, key = ~ county_name)
title = 'Graduates as a Percentage of Four-Year Adjusted Cohort Students'

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),   # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols
##Ignoring 160 observations that are NA##

```


## Third Grade English Proficiency - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_3_chart <- c_3 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_3_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Filipinx Rate: </strong>{point.nh_filipino_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}"),
    allowOverlap = FALSE) %>%
    hc_title(text = "3rd Graders Scoring Proficient or Better in English Language Arts (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "3rd Grade English Proficiency"]), 
    "<br>Students scoring proficient or advanced on the third grade English Language Arts/Literacy (Smarter Balanced and California Alternate Assessment) test as a percentage of all third graders tested.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% 
  #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* Modoc County has the lowest rates in this measure, with only one in five 3rd graders scoring Proficient or Better in ELA.

* Imperial County is the most disparate in this measure, with a 41.5 percentage point difference between the groups with the highest and lowest rate. 

 

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
title = "3rd Graders Scoring Proficient or Better in English Language Arts (%)"
s_3_ <- s_3 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_3_long <- melt(s_3_, id.vars=c("state_name"))
s_3_long <- s_3_long[order(-s_3_long$value),]
s_3_long <- s_3_long %>% mutate_if(is.double, ~round(., 1))

s_3_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_3$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_3$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

``` 
* Statewide, two groups emerge. In the first group, fewer than one in three NH-AIAN, Latinx, NH-Black, and NHPI students scored proficient. While in the second group, more than 50% of Asian, Filipinx, Two or More Races, and White third graders scored proficient in English Language Arts. 


### County Barchart

```{r}


c_3_long <- c_3 %>%
   select(c(2, ends_with('_rate')))

c_3_long <- melt(c_3_long, id.vars=c("county_name"))
# Round 'value' field to 1 decimal
c_3_long <- c_3_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_3_long, key = ~ county_name)
title = "3rd Graders Scoring Proficient or Better in English Language Arts (%)"

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),   # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Third Grade Math Proficiency - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_4_chart <- c_4 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_4_chart %>%
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:,.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:,.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:,.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:,.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:,.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:,.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:,.1f} <br><strong>Filipinx Rate: </strong>{point.nh_filipino_rate:,.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:,.1f}")) %>%
    hc_title(text = "3rd Graders Scoring Proficient or Better in Math (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "3rd Grade Math Proficiency"]), 
    "<br>Students scoring proficient or advanced on the third grade Mathematics test (Smarter Balanced and California Alternate Assessment) as a percentage of all third graders tested.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* Modoc County is the lowest performing on this measure with less than 25% of its students scoring Proficient or Better in Math.

* Larger population counties have above average levels of racial disparities among racial and ethnic groups for this indicator.

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
title = "3rd Graders Scoring Proficient or Better in Math (%)"
s_4_ <- s_4 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_4_long <- melt(s_4_, id.vars=c("state_name"))
s_4_long <- s_4_long[order(-s_4_long$value),]
s_4_long <- s_4_long %>% mutate_if(is.double, ~round(., 1))

s_4_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_4$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_4$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


```
* Statewide, two groups emerge. In the first group, about one in three NH-AIAN, NH-Black, Latinx, and NH-PI students scored proficient. While in the second group, more than 50% of Asian, Filipinx, White, Two or More Races third graders scored proficient in math. 

### County Barchart

```{r}

c_4_long <- c_4 %>%
   select(c(2, ends_with('_rate')))

c_4_long <- melt(c_4_long, id.vars=c("county_name"))
# Round 'value' field to 1 decimal
c_4_long <- c_4_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_4_long, key = ~ county_name)
title = "3rd Graders Scoring Proficient or Better in Math (%)"

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),   # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Suspensions - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_5_chart <- c_5 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_5_chart  %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Filipinx Rate: </strong>{point.nh_filipino_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Students Suspended per 100 Students") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Suspensions"]), 
    "<br>Students suspended include those who were suspended for any reason, including willful defiance.", 
    "<br>This rate is calculated using cumulative enrolled students which consists of the total number of unduplicated primary and short-term enrollments within the academic year.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```
* Inyo County is the most racially disparate for this measure, with suspension rates for NH-AIAN students reaching 7.1% while the suspension rates for the lowest group is 0.

* Three counties (Modoc, Lake, and Del Norte) in the Northern California region are the lowest performing for this measure, with suspension rates at or nearing 10%. 


### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3

title = "Students Suspended per 100 Students"

s_5_ <- s_5 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_5_long <- melt(s_5_, id.vars=c("state_name"))
s_5_long <- s_5_long[order(s_5_long$value),]
s_5_long <- s_5_long %>% mutate_if(is.double, ~round(., 1))

s_5_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_5$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_5$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

```
* NH-Pacific Islander, Latinx, NH-AIAN, and NH-Black students are suspended at above state average rates. 

* NH-Black students are suspended at a rate 8.0 times higher than the lowest suspension rate. 

### County Barchart

```{r}

c_5_long <- c_5 %>%
   select(c(2, ends_with('_rate')))

c_5_long <- melt(c_5_long, id.vars=c("county_name"))
# Round 'value' field to 1 decimal
c_5_long <- c_5_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_5_long, key = ~ county_name)
title = "Students Suspended per 100 Students"

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## ECE Access - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_6_chart <- c_6 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_6_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.county_total_und5:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.twoormor_rate:.1f}")) %>%
  hc_title(text = "Children 0-5 Enrolled in Licensed ECE Program (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Early Childhood Education Access"]), 
    "<br>Licensed childcare (CCCRRN) and Transitional Kindergarten (AIR) enrollment per 100 children aged 0-5 (AIR).", 
    "<br>Accessible childcare refers to enrollment in one's neighborhood defined here as one's ZIP Code.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)
       

```
* 22.2% of San Bernardino County children ages 0-5 have access to a licensed ECE program, which is a 62.4 percentage point difference from Modoc County (84.6%), the county with the most access. 



### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate

title = "Children 0-5 Enrolled in Licensed ECE Program (%)"
s_6_ <- s_6 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_6_long <- melt(s_6_, id.vars=c("state_name"))
s_6_long <- s_6_long[order(-s_6_long$value),]
s_6_long <- s_6_long %>% mutate_if(is.double, ~round(., 1))

s_6_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_6$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_6$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

``` 
* ECE access rates are low across the state and for all groups, even the best rate means less than one in two children has access. Still NH-AIAN, Latinx, and NH-Black children all have less ECE access than the state average.

### County Barchart

```{r}

c_6_long <- c_6 %>%
   select(c(2, ends_with('_rate')))

c_6_long <- melt(c_6_long, id.vars=c("county_name"))
# Round 'value' field to 1 decimal
c_6_long <- c_6_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_6_long, key = ~ county_name)
title = "Children 0-5 Enrolled in Licensed ECE Program (%)"

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),   # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```



## Diversity of Teachers  - NOT UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_7_chart <- c_7 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_7_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_raw, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_enroll:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.nh_pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Filipinx Rate: </strong>{point.nh_filipino_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
  hc_title(text = "Teachers of a Race per 100 Students of Same Race") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Teacher & Staff Diversity"]), 
    "<br>Ratio of staff of a race per 100 students of the same race.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)
       

```
* Larger population counties overall are in the Yellow (Lower disparity, Lower performance) Quadrant, with Low Angeles County having the lowest disparity.

* All but two (Mariposa and Tuolumne) Central Valley counties are in the Yellow (Lower disparity, Lower performance) and Red (Higher disparity, Lower performance) Quadrants.

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate

title = "Teachers of a Race per 100 Students of Same Race"
s_7_ <- s_7 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_7_long <- melt(s_7_, id.vars=c("state_name"))
s_7_long <- s_7_long[order(-s_7_long$value),]
s_7_long <- s_7_long %>% mutate_if(is.double, ~round(., 1))

s_7_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_7$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_7$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

``` 
* White students have by far the highest representation, with more than 13 White teachers and staff per 100 White students. Compare this to NH-AIANs, the group with the next highest rate, at five per 100 students.

### County Barchart

```{r}

c_7_long <- c_7 %>%
   select(c(county_name, ends_with('_rate')))

c_7_long <- melt(c_7_long, id.vars=c("county_name"))
# Round 'value' field to 1 decimal
c_7_long <- c_7_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_7_long, key = ~ county_name)
title = "Teachers of a Race per 100 Students of Same Race"

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),   # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

##Disconnect from db
dbDisconnect(con)
dbDisconnect(con2)

```


```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-5) for a total of 6 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```


```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 }
window.onload = filter_default;
```




