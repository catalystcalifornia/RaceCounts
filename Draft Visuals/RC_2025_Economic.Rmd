---
title: "RACE COUNTS: Economic Opportunity"
author: "Authored by: Catalyst California"
date: "8/25/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r include = FALSE}
### install version 1.1.1 of Crosstalk -- LATER VERSIONS OF CROSSTALK WILL NOT WORK ####
#remotes::install_version("crosstalk", version = "1.1.1", repos = "http://cran.us.r-project.org") 
# library(crosstalk)

#Set up workspace
packages <- c("crosstalk", "RPostgres", "sf", "htmltools", "tidyr", "reshape2", "plotly", "tidyverse", "highcharter",
              "DT","formattable","knitr","dplyr","leaflet","stringr","rpostgis","RColorBrewer","ggplot2","stringr","scales","colorspace",                "here","htmltools","devtools","broom","kableExtra")  

install_packages <- packages[!(packages %in% installed.packages()[,"Package"])] 

if(length(install_packages) > 0) { 
  install.packages(install_packages) 
  
} else { 
  
  print("All required packages are already installed.") 
} 

for(pkg in packages){ 
  library(pkg, character.only = TRUE) 
} 
options(scipen=999)

```


```{r setup, include = FALSE}

knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

#setwd("W:/Project/RACE COUNTS/2024_v7/Visualizations/") 


# data setup w/o credentials
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("racecounts")

source("W:\\RDA Team\\R\\credentials_source.R")
con2 <- connect_to_db("rda_shared_data")

# just a note of reference to inserting text #https://monashbioinformaticsplatform.github.io/2017-11-16-open-science-training/topics/rmarkdown.html
#https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf

```


```{r echo=FALSE, include = FALSE}

##Add RC theme##
rc_theme <- hc_theme(
    # race counts colors
  colors = c("orange", "purple","red", "yellow"),
  chart = list(
    backgroundColor = "#FFFFFF",
    borderColor = "black",
    style = list(
          fontFamily = "Rubik") 
  ),
  title = list(
    style = list(
      color = "#070024",
      fontFamily = "Rubik")
  ),
  subtitle = list(
    style = list(
      color = "#8E8C8F", # medium grey
      fontFamily = "Rubik")
  ),
  caption = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
    axis = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
  legend = list(
    itemStyle = list(
      fontFamily = "Rubik",
      color = "#070024"),
    itemHoverStyle = list(
       fontFamily = "Rubik",
      color = "#070024")
  ))


lang <- getOption("highcharter.lang")
lang$thousandsSep <- ","
options(highcharter.lang = lang)

####################### ADDED v7 COUNTY DATA #####################################

c_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_living_wage_county_2025"))  
c_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_employment_county_2025"))
c_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_internet_county_2025"))
c_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_per_capita_income_county_2025"))
c_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_officials_county_2025"))
c_6 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_real_cost_measure_county_2025"))
c_7 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_connected_youth_county_2025"))

c_index_z <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_index_2025"))


####################### POPULATION DATA #####################################
#Join total population 
pop <- dbGetQuery(con2, paste0("SELECT geoid, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_2023"))

c_index_z <- left_join(x = c_index_z, y = pop, by = c("county_id" = "geoid"))

c_4 <- left_join(x = c_4, y = pop, by = c("county_id" = "geoid"))


####################### ADD STATE DATA #####################################
s_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_living_wage_state_2025"))  
s_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_employment_state_2025"))
s_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_internet_state_2025"))
s_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_per_capita_income_state_2025"))
s_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_officials_state_2025"))
s_6 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_real_cost_measure_state_2025"))
s_7 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_econ_connected_youth_state_2025"))

# merge with urban type 
region_urban_type <- dbGetQuery(con, paste0("SELECT geoid AS county_id, region, urban_type FROM v6.arei_multigeo_list")) # Using v5 data for now, will update later with v7 data once available

c_1 <- left_join(c_1, region_urban_type)
c_2 <- left_join(c_2, region_urban_type)
c_3 <- left_join(c_3, region_urban_type)
c_4 <- left_join(c_4, region_urban_type)
c_5 <- left_join(c_5, region_urban_type)
c_6 <- left_join(c_6, region_urban_type)
c_7 <- left_join(c_7, region_urban_type)

##Add 2024 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_indicator_list_cntyst"))
```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>PERFORMANCE: How well people are doing. The higher the circle, the better the performance.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.

# Key Findings 

* Central Valley counties exhibit lower economic performance and greater racial disparity in economic opportunity and wages compared to other counties. (See scatterplot on Economic Opportunity Index and People Ages 18-64 Earning A Living Wage (%))


* NH-White and Asian residents across the counties have higher per capita income compared to other racial groups, who earn below the average income rate for all groups. (See bar chart on Per Capita Income ($))

* NH-AIAN, NH-Black, and Latinx residents have incomes that fall below the cost-of-living-adjusted poverty rate. (See bar chart on Households Above Real Cost Measure ($))

* Pacific Islanders, Latinx, AIAN, and NH-Black residents are far less likely to be employed as officials or managers. (See bar chart on People Ages 18-64 in labor Force who are Employed as Officials or Managers per 1k People)


# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "NH_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "two_or_more" group represents those who identify as Two or More Races.

# Indicators

## Economic Opportunity Index {.tabset .tabset-fade}
```{r}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
 c_index_chart <- c_index_z %>% mutate(
    disp_z_cap = case_when(
      economic_opportunity_disparity_z > 2 ~ 2,
      economic_opportunity_disparity_z < -2 ~ -2,
      TRUE ~ economic_opportunity_disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      economic_opportunity_performance_z > 2 ~ 2,
      economic_opportunity_performance_z < -2 ~ -2,
      TRUE ~ economic_opportunity_performance_z)
    ) %>% filter(economic_opportunity_quadrant %in% c("yellow", "orange", "red", "purple"))

 c_index_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=economic_opportunity_quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.economic_opportunity_performance_rank} <br><strong>Disparity Rank: </strong>{point.economic_opportunity_disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f}")) %>%
  hc_title(text = "Economic Opportunity Index") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 2, min = -2) %>%     ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 2, min = -2) %>%   ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_caption(
    text = "Data source: Various <br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes.",
    align = "center"
     ) %>%
  #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```

* Most Central Valley counties have lower than average performance, with most having higher than average disparity as well. 

* All Bay Area counties have higher than average performance with low levels of disparity on the Economic Opportunity Index. However, Marin, Napa, and San Francisco also have higher than average levels of disparity.

## Living Wage {.tabset .tabset-fade}


### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_1_chart <- c_1 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

 c_1_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=pop_total, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.pop_total:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.nh_other_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
  hc_title(text = "People Ages 18-64 Earning a Living Wage (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Living Wage"]), 
    "<br>Living Wage is defined as $15.50 or more per hour.", 
    "<br> A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```

* Most Central Valley counties have below average performance on this measure.

* All Bay Area counties have high performance and all but two (Marin and Napa) below average disparity measures. 

### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3 - done
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "People Ages 18-64 Earning a Living Wage (%)"
s_1_ <- s_1 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_1_long <- melt(s_1_, id.vars=c("state_name"))
s_1_long <- s_1_long[order(-s_1_long$value),]
s_1_long <- s_1_long %>% mutate_if(is.double, ~round(., 1))

s_1_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_1$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_1$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

``` 


*Nh-Black, Latinx, and AIAN workers are less likely to earn a living wage compared to the average rate across all groups.

### County Barchart

```{r}

c_1_long <- c_1 %>%
   select(c(2, ends_with('_rate')))

c_1_long <- melt(c_1_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_1_long$value when MAX is best.
c_1_long <- c_1_long[order(-c_1_long$value),]
# Round 'value' field to 1 decimal
c_1_long <- c_1_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_1_long, key = ~ county_name)
title = 'People Ages 18-64 Earning a Living Wage (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1, width = 600) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title),
            
            
             
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
 )# end bscols

##Warning that it is ignoring 250 observations is due to plotly ignoring NA values##

```


## Employment Status  {.tabset .tabset-fade}

### Scatterplot

```{r}
c_2_chart <- c_2 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z))%>%
      filter(quadrant %in% c("purple", "yellow", "orange", "red"))

    
c_2_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.twoormor_rate:.1f}")) %>%
    hc_title(text = "Employment to Population Ratio (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Employment"]), 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)
```

* Most counties in the Northern California region have lower than average performance when it comes to this measure.

* Counties with larger populations are generally in the Purple Quadrant (Lower Disparity, Higher Performance). 

### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
##Need to update this title.

title = "Employment to Population Ratio (%)"
s_2_ <- s_2 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_2_long <- melt(s_2_, id.vars=c("state_name"))
s_2_long <- s_2_long[order(-s_2_long$value),]
s_2_long <- s_2_long %>% mutate_if(is.double, ~round(., 1))

s_2_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_2$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_2$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


```

* Only the Black, AIAN, and NH-White employment rates are lower than the state average (59.3%). 

* The rate of employment for Black residents is 1.2 times lower than the group with the highest rate.

### County Barchart

```{r}
c_2_long <- c_2 %>%
   select(c(county_name, ends_with('_rate')))

c_2_long <- melt(c_2_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_2_long$value when MAX is best.
c_2_long <- c_2_long[order(-c_2_long$value),]
# Round 'value' field to 1 decimal
c_2_long <- c_2_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_2_long, key = ~ county_name)
title = 'Employment to Population Ratio (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

##Warning that it is ignoring 48 observations is due to plotly ignoring NA values##
```


## Internet Access {.tabset .tabset-fade}


### Scatterplot

```{r}
c_3_chart <- c_3 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_3_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.other_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.twoormor_rate:.1f}")) %>%
    hc_title(text = "Persons with Internet Access (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Internet Access"]), 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```

* Counties with larger populations tend to have more access to the internet and are in the Purple Quadrant (Lower Disparity, Higher Performance).

* There does seem to be a link between lower disparity and higher performance on this measure.

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Persons with Internet Access (%)"
s_3_ <- s_3 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_3_long <- melt(s_3_, id.vars=c("state_name"))
s_3_long <- s_3_long[order(-s_3_long$value),]
s_3_long <- s_3_long %>% mutate_if(is.double, ~round(., 1))

s_3_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_3$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_3$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)



``` 

* More than 9 in 10 Californians have internet access.
* The internet access rate for Black, Latinx, AIAN, Pacific Islander, and Other race residents are lower than the average rate for all groups. 

### County Barchart

```{r}

c_3_long <- c_3 %>%
   select(c(2, ends_with('_rate')))

c_3_long <- melt(c_3_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_3_long$value when MAX is best.
c_3_long <- c_3_long[order(-c_3_long$value),]
# Round 'value' field to 1 decimal
c_3_long <- c_3_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd3 <- SharedData$new(c_3_long, key = ~ county_name)
title = 'Persons with Internet Access (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd3,
                ~ county_name, multiple = FALSE),
   plot_ly(sd3) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
 )  # end layout
 )# end bscols


```


## Per Capita Income {.tabset .tabset-fade}


### Scatterplot

```{r}
c_4_chart <- c_4 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_4_chart %>%
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>${point.total_rate:,.0f} <br><strong>Latinx Rate: </strong>${point.latino_rate:,.0f} <br><strong>Black Rate: </strong>${point.black_rate:,.0f} <br><strong>AIAN Rate: </strong>${point.aian_rate:,.0f} <br><strong>NHPI Rate: </strong>${point.pacisl_rate:,.0f} <br><strong>Asian Rate: </strong>${point.asian_rate:,.0f} <br><strong>White Rate: </strong>${point.nh_white_rate:,.0f} <br><strong>Other Rate: </strong>${point.other_rate:,.0f} <br><strong>Two or More Races Rate: </strong>${point.twoormor_rate:,.0f}")) %>%
    hc_title(text = "Per Capita Income ($)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4, breakSize = 2) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Per Capita Income"]), 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* Per capita income performance is close to average in all quadrants, except in the Orange quadrant (Higher Disparity, Higher Performance). There is a lot of variation in performance (average Per Capita Income) among that group. 

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3 

title = "Per Capita Income ($)"
s_4_ <- s_4 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_4_long <- melt(s_4_, id.vars=c("state_name"))
s_4_long <- s_4_long[order(-s_4_long$value),]
s_4_long <- s_4_long %>% mutate_if(is.double, ~round(., 0))    # Round 'value' field to 0 decimals for this indicator only

s_4_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title), 
           plotLines = list(
                list(
                  value = s_4$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                    # the next line has extra code (label_comma) to add $ prefix and thousands separator - applies only for per capita income
                  label = list(text = paste0("Total Rate: $",label_comma(accuracy = 1)(s_4$total_rate)), style = list(color = "black", fontSize = 16), align = "right")))) %>%

  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_tooltip(valuePrefix = "$") %>%                           # extra line this chart only to add $ prefix to tooltip
  #hc_size(height=400,width=700) %>% 
  hc_add_theme(rc_theme)


```

* Non-Hispanic White and Asian residents have above-average per capita income compared to other groups. 

### County Barchart

```{r}


c_4_long <- c_4 %>%
   select(c(2, ends_with('_rate')))

c_4_long <- melt(c_4_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_4_long$value when MAX is best.
c_4_long <- c_4_long[order(-c_4_long$value),]
# Round 'value' field to 1 decimal
c_4_long <- c_4_long %>% mutate(value = round(value, 0)) 


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd4 <- SharedData$new(c_4_long, key = ~ county_name)
title = 'Per Capita Income ($)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd4,
                ~ county_name, multiple = FALSE),
   plot_ly(sd4) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
            xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            # https://plotly-r.com/controlling-tooltips.html
             yaxis = list(title = title, ntick = 5, range = c(0,max), tickformat = "$,.0f", hoverformat = "$,.0f"),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Officials & Managers {.tabset .tabset-fade}

### Scatterplot

```{r}
c_5_chart <- c_5 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_5_chart  %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=pop_total, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.pop_total:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "People Ages 18-64 in Labor Force who are Employed as Officials or Managers per 1k People") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Officials and Managers"]), 
    "<br>Officials and managers includes executive/senior level officials", 
    "<br>and managers and first/mid-level officials and managers by residential address.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```

* Counties with larger populations tend to have lower disparity levels for this measure.  
* San Luis Obispo has the worst racial disparity by far on this measure, in part due to lower rates for Latinx residents. 

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
title = "People Ages 18-64 in Labor Force Who Are Employed as Officials or Managers per 1k People"
s_5_ <- s_5 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_5_long <- melt(s_5_, id.vars=c("state_name"))
s_5_long <- s_5_long[order(-s_5_long$value),]
s_5_long <- s_5_long %>% mutate_if(is.double, ~round(., 1))

s_5_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_5$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_5$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


```

* Non-Hispanic White workers are 2.4 times more likely to be employed as officials or managers than Latinx workers.

### County Barchart

```{r}
c_5_long <- c_5 %>%
   select(c(county_name, ends_with('_rate')))

c_5_long <- melt(c_5_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_5_long$value when MAX is best.
c_5_long <- c_5_long[order(-c_5_long$value),]
# Round 'value' field to 1 decimal
c_5_long <- c_5_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd5 <- SharedData$new(c_5_long, key = ~ county_name)
title = 'People Ages 18-64 in Labor Force Who Are<br>Employed as Officials or Managers per 1k People'

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd5,
                ~ county_name, multiple = FALSE),
   plot_ly(sd5) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Real Cost Measure {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_6_chart <- c_6 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_6_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_raw, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank}  <br><strong>HHs Above Real Cost Measure: </strong>{point.total_raw:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.black_rate:.1f} <br><strong>API Rate: </strong>{point.api_rate:.1f} <br><strong>White Rate: </strong>{point.white_rate:.1f}")) %>%
  hc_title(text = "Households Above Real Cost Measure (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Cost-of-Living Adjusted Poverty"]), 
    "<br>The Real Cost Measure of poverty accounts for local costs of living, including the costs of housing, food,", 
    "<br>health care, child care, transportation and other basic needs. It is a more accurate measure of financial security", 
    "<br>than the federal poverty measure. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>%     #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)
       

```

* Counties with larger populations have below average measures of disparity.
* Marin County has the most racial disparity on this measure by far, in part due to lower rates for Latinx residents.

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Households Above Real Cost Measure (%)"
s_6_ <- s_6 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_6_long <- melt(s_6_, id.vars=c("state_name"))
s_6_long <- s_6_long[order(-s_6_long$value),]
s_6_long <- s_6_long %>% mutate_if(is.double, ~round(., 1))

s_6_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_6$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_6$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


``` 

*NH-AIAN, Black, and Latinx residents earn incomes below the cost-of-living-adjusted poverty rate. 

### County Barchart

```{r}
c_6_long <- c_6 %>%
   select(c(2, ends_with('_rate')))

c_6_long <- melt(c_6_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_6_long$value when MAX is best.
c_6_long <- c_6_long[order(-c_6_long$value),]
# Round 'value' field to 1 decimal
c_6_long <- c_6_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long


sd6 <- SharedData$new(c_6_long, key = ~ county_name)
title = 'Households Above Real Cost Measure (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd6,
                ~ county_name, multiple = FALSE),
   plot_ly(sd6) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

```


## Connected Youth {.tabset .tabset-fade}

### Scatterplot

```{r}
c_7_chart <- c_7 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_7_chart  %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=pop_total, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.pop_total:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Connected Youth (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Connected Youth"]), 
    "<br>Connected Youth are youth ages 16-24 who are in school and/or employed.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```

* Performance is close to average in all quadrants, except Red (Higher Disparity, Lower Performance) and Yellow (Lower Disparity, Lower Performance). There is a lot of variation in performance (average Connected Youth Rate) among those groups. 

* Mendocino county has the most racial disparity on this measure by far, in part due to lower rates for NH-AIAN youth. 

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
title = "Connected Youth (%)"
s_7_ <- s_7 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_7_long <- melt(s_7_, id.vars=c("state_name"))
s_7_long <- s_7_long[order(-s_7_long$value),]
s_7_long <- s_7_long %>% mutate_if(is.double, ~round(., 1))

s_7_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_7$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_7$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


```

* Black youth have a rate of 13.4 percentage points lower than the group with the highest rate. 

### County Barchart


```{r}
c_7_long <- c_7 %>%
   select(c(county_name, ends_with('_rate')))

c_7_long <- melt(c_7_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_7_long$value when MAX is best.
c_7_long <- c_7_long[order(-c_7_long$value),]
# Round 'value' field to 1 decimal
c_7_long <- c_7_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd7 <- SharedData$new(c_7_long, key = ~ county_name)
title = 'Connected Youth (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd7,
                ~ county_name, multiple = FALSE),
   plot_ly(sd7) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
   %>%
    
    add_lines(
    y = c_7$total_rate, 
    x = 0,
    line = list(
      color = "grey"
    ),
    inherit = FALSE,
    showlegend = FALSE
  )
) # end bscols


##Disconnect from database
dbDisconnect(con)
dbDisconnect(con2)

```

```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-5) for a total of 6 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```
Warning: Specifying width/height in layout() is now deprecated.
Please specify in ggplotly() or plot_ly()Warning: Sum of bscol width units is greater than 12Warning: Ignoring 241 observationsWarning: Ignoring 241 observations> 

```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[6].selectize.setValue("Alameda", false);
 }
window.onload = filter_default;
```




