---
title: "RACE COUNTS: Health Care Access               "
author: "Authored by: Catalyst California"
date: "9/4/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

#load the libraries via the below source as well as the credentials and set the theme
source("draft_visual_functions.R")

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

##Add RC theme##
rc_theme # load from the above draft_visual_functions.R script

##### UPDATE EACH YEAR AND FOR EACH ISSUE AREA ####
issue_name <- 'Health Care Access' # Issue names: Safety & Justice, Democracy, Economic Opportunity, Education, Healthy Built Environment, Health Care Access, Housing
issue <- 'hlth' #Issue: crim, demo, educ, econ, hben, hlth, hous
rc_schema <- 'v7'
rc_yr <- '2025'
acs_yr <- '2023'

```

```{r echo=FALSE, include = FALSE}

####################### GET COUNTY DATA #####################################
county_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%county_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

county_list <- dbGetQuery(con, county_list_query) %>% pull(table_name) 

c_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", county_list), county_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
c_tables <- map2(c_tables, names(c_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
c_tables <- lapply(c_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_county_', rc_yr), '', indicator),
         geolevel = 'county'))

# Get issue index
c_index_z <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_", issue, "_index_", rc_yr)) %>%
  rename(geo_name = county_name)  # make 'name' col generic

####################### POPULATION DATA #####################################
#Get total population
pop <- dbGetQuery(con, paste0("SELECT geoid, total_pop, geolevel FROM ", rc_schema, ".arei_race_multigeo WHERE geolevel = 'county'")) %>% select(-geolevel)

c_index_z <- left_join(c_index_z, pop, by = c("county_id" = "geoid"))

c_tables <- lapply(c_tables, function(x) 
  x %>% left_join(pop, by = c("county_id" = "geoid")))

## Make 'name' col generic
c_tables <- lapply(c_tables, function(x)
  x %>% rename(geo_name = county_name))

####################### GET STATE DATA #####################################
state_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%state_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

state_list <- dbGetQuery(con, state_list_query) %>% pull(table_name) 

s_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", state_list), state_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
s_tables <- map2(s_tables, names(s_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
s_tables <- lapply(s_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_state_', rc_yr), '', indicator),
         geolevel = 'state'))


##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_indicator_list_cntyst"))
v7_sources <- v7_sources %>% filter(v7_sources$arei_issue_area==issue_name) %>%
  select(arei_indicator, arei_issue_area, rate_descriptor, bar_chart_header, rate_rounding, methodology, data_source, api_name)


## Join metadata to data
c_tables <- lapply(c_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))
s_tables <- lapply(s_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))

names(c_tables)
names(s_tables)
```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>PERFORMANCE: How well people are doing. The higher the circle, the better the outcome
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.


# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Multiracial.

# Indicators

## Health Care Access Index - UPDATED
```{r, echo=FALSE}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
  c_index_z <- c_index_z %>% mutate(arei_issue_area=issue_name)
  c_index_chart <- index_scatterplot(c_index_z, 2)

  c_index_chart
```
* Marin County has the best overall Health Care access but also ranks as the sixth most disparate county in the state.
* Looking across indicators, Black Californians fare worse than other groups in 3 out of the 6 indicators for Health Care Access.
* All eight of the counties in the San Joaquin Valley Region have lower than average outcomes when it comes to health care access. They are all in the red or yellow quadrants.
* All nine Bay Area counties have above average health care access outcomes, with five out of the nine counties also having lower than average rates of racial disparity.

## Low Birthweight - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE} 
c_1_chart <- county_scatterplot(c_tables[[1]])
c_1_chart

```
* There is also a moderately strong, negative correlation between population and outcome. Higher population counties tend to experience higher (worse) rates of infants with low birthweight. The notable exception is Orange County, which is the third most populous county in the state and is in the purple quadrant (higher outcome, lower disparity).
* Sacramento and Kern counties exhibit the largest racial disparities in low birthweight rates, with Black birth outcomes notably on the wrong end of these disparities. In Sacramento and Kern, Black infants are more than 2x more likely to be underweight than White infants.

### State Barchart
```{r, echo=FALSE}

  s_1_ <- state_barchart(s_tables[[1]])
  s_1_

``` 
* Black babies have the significantly highest likelihood of having low birthweight of any racial group in California. They are 1.5x more likely than the group with the next highest rate (American Indian/Alaska Native), and more than 2x more likely than the group with the lowest rate (White).

### County Barchart

```{r, echo=FALSE}
c_1_long <- county_barchart(c_tables[[1]]) 
c_1_long
```



## Lack of Health Insurance - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_2_chart <- county_scatterplot(c_tables[[2]])
c_2_chart

```
* Similar to the mental health/substance abuse help indicator, Marin County has the third highest overall rate of health insurance, but the third worst racial disparity. Latinx residents of the county are nearly 7x more likely to be uninsured rate than White residents.
* Sierra County has the highest disparity and is tied for worst outcome among counties. Over half of its Latinx population is uninsured -- a rate 7.5x higher than its White population. 
* Los Angeles County is one of the worst outcome counties. Almost 9% of LAC residents are uninsured, including 12.9% of its Latinx residents.


### State Barchart
```{r, echo=FALSE}
  s_2_ <- state_barchart(s_tables[[2]])
  s_2_

```
* White residents are half as likely to be uninsured as the average Californian.
* Latinx and American Indian/Alaska Native Californians are about 3x more likely to be uninsured than White residents. 
* Californians who identify with a "another race" are the most likely to be uninsured. Although it is difficult to know which individuals identify with this group, it likely includes many who are Latinx (as "Another Race" includes Latinx for this indicator) and those with origins in Southwest Asia and North Africa, among others.


### County Barchart

```{r, echo=FALSE}
c_2_long <- county_barchart(c_tables[[2]]) 
c_2_long
```


## Preventable Hospitalizations - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_3_chart <- county_scatterplot(c_tables[[3]])
c_3_chart
```
* Notably, in San Mateo which has the least disparity and the fourth best outcomes, Black residents are twice as likely to be hospitalized as the average resident.
* In many counties, some of the highest rates are for Another Race, local knowledge will be needed to better understand who makes up this group in each county.

### State Barchart

```{r, echo=FALSE}

  s_3_ <- state_barchart(s_tables[[3]])
  s_3_

``` 
* The Black preventable hospitalization rate is nearly 5x higher than that of the group with the lowest rate, and 2.5x higher than even the state average.
* The preventable hospitalization rate for White Californians is about 8% higher than the state average and more than 2x higher than the rate of group with the lowest rate. This is the only health metric in which White residents experience worse outcomes than the state average.


### County Barchart

```{r, echo=FALSE}
c_3_long <- county_barchart(c_tables[[3]]) 
c_3_long
```


## Got Help - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_4_chart <- county_scatterplot(c_tables[[4]])
c_4_chart
```
* Marin County has both the worst disparities and the best outcomes on this indicator. A very low Asian rate (31.4%) and a low AIAN rate (47.8) are behind the disparity. On average, 66.9% of Marin residents get help for these issues compared to the state average of 57.4%.
*

### State Barchart

```{r, echo=FALSE}

  s_4_ <- state_barchart(s_tables[[4]])
  s_4_

```
* Statewide, Asian residents are the least likely to get help, followed by Latinx and Pacific Islanders.


### County Barchart

```{r, echo=FALSE}
c_4_long <- county_barchart(c_tables[[4]]) 
c_4_long
```


## Life Expectancy - NOT UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_5_chart <- county_scatterplot(c_tables[[5]])
c_5_chart

```
* Five of the six counties in Southern California have greater than average racial disparities in life expectancy. 
* Every county in the San Joaquin Valley has below average life expectancy rates.
* Less populous, less urban counties tend to have fewer racial disparities in life expectancy. Of the 15 least disparate counties in this measure, none of them are classified as urban and only one is among the top ten most populous counties in the state.
* The state's most populous, more urban counties tend to exhibit greater racial disparities in life expectancy. San Francisco, San Bernardino, Santa Clara, Los Angeles, San Diego, and Alameda counties are all among the top 20 for disparity levels in this metric.

### State Barchart

```{r, echo=FALSE}
  s_5_ <- state_barchart(s_tables[[5]])
  s_5_
```
* Asians have the highest life expectancy, followed by non-Latinx White Californians. Non-Latinx Blacks have the lowest life expectancy rate in the state, six years lower than the average statewide rate.

### County Barchart

```{r, echo=FALSE}

c_5_long <- county_barchart(c_tables[[5]]) 
c_5_long

```


## Usual Source of Care - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_6_chart <- county_scatterplot(c_tables[[6]])
c_6_chart

```
* All nine Bay Area counties have above average usual source of care rates among their populations and eight counties are in the purple Quadrant (Lower Disparity, Higher Outcome).
* Counties with larger populations tend to have lower levels of racial disparity in their usual source of care rates, with only two of the 16 counties with 500,000 or more residents appearing in the higher disparity quadrants (Orange and Red).

### State Barchart

```{r, echo=FALSE}
  s_6_ <- state_barchart(s_tables[[6]])
  s_6_

``` 
* Latinx, Pacific Islander, AIAN, SWANA, and Asian Californians are less likely to have a usual source of care than the average Californian.
* The Latinx and Pacific Islander usual source of care rates (78.5) are over nine percentage points lower the White rate (87.7).


### County Barchart

```{r, echo=FALSE}

c_6_long <- county_barchart(c_tables[[6]]) 
c_6_long

```


```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-5) for a total of 6 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```

```{r, echo=FALSE}
##Closing database connections##
dbDisconnect(con)
dbDisconnect(con2)

```

```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 }
window.onload = filter_default;
```





