---
title: "RACE COUNTS: Crime and Justice"
author: "Authored by: Catalyst California"
date: "8/25/2025"
output:
  html_document: 
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r include = FALSE}
### install version 1.1.1 of Crosstalk -- LATER VERSIONS OF CROSSTALK WILL NOT WORK ####
# remotes::install_version("crosstalk", version = "1.1.1", repos = "http://cran.us.r-project.org") 
# library(crosstalk)

#Set up workspace
packages <- c("crosstalk", "RPostgres", "sf", "htmltools", "tidyr", "reshape2", "plotly", "tidyverse", "highcharter")  

install_packages <- packages[!(packages %in% installed.packages()[,"Package"])] 

if(length(install_packages) > 0) { 
  install.packages(install_packages) 
  
} else { 
  
  print("All required packages are already installed.") 
} 

for(pkg in packages){ 
  library(pkg, character.only = TRUE) 
} 
options(scipen=999)

```


```{r setup, include = FALSE}

knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

#setwd("W:/Project/RACE COUNTS/2025_v7/Visualizations/") 

# data setup w/o credentials
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("racecounts")

source("W:\\RDA Team\\R\\credentials_source.R")
con2 <- connect_to_db("rda_shared_data")

# just a note of reference to inserting text #https://monashbioinformaticsplatform.github.io/2017-11-16-open-science-training/topics/rmarkdown.html
#https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf

```


```{r echo=FALSE, include = FALSE}

##Add RC theme##
rc_theme <- hc_theme(
    # race counts colors
  colors = c("orange", "purple", "red", "yellow"),
  chart = list(
    backgroundColor = "#FFFFFF",
    borderColor = "black",
    style = list(
          fontFamily = "Rubik") 
  ),
  title = list(
    style = list(
      color = "#070024",
      fontFamily = "Rubik")
  ),
  subtitle = list(
    style = list(
      color = "#8E8C8F", # medium grey
      fontFamily = "Rubik")
  ),
  caption = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
    axis = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
  legend = list(
    itemStyle = list(
      fontFamily = "Rubik",
      color = "#070024"),
    itemHoverStyle = list(
       fontFamily = "Rubik",
      color = "#070024")
  ))


lang <- getOption("highcharter.lang")
lang$thousandsSep <- ","
options(highcharter.lang = lang)

####################### ADD COUNTY DATA #####################################

c_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_incarceration_county_2025"))
c_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_perception_of_safety_county_2025"))
c_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_status_offenses_county_2025"))
c_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_use_of_force_county_2025"))
c_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_officer_initiated_stops_county_2025")) ##Added new indicator - Officer-initiated stops

c_index_z <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_index_2025"))


####################### POPULATION DATA #####################################
#Join total population to index view, indicator data frames
pop <- dbGetQuery(con2, paste0("SELECT geoid, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_2023"))

c_index_z <- left_join(x = c_index_z, y = pop, by = c("county_id" = "geoid"))

c_1 <- left_join(x = c_1, y = pop, by = c("county_id" = "geoid"))
c_2 <- left_join(x = c_2, y = pop, by = c("county_id" = "geoid"))
c_3 <- left_join(x = c_3, y = pop, by = c("county_id" = "geoid"))
c_4 <- left_join(x = c_4, y = pop, by = c("county_id" = "geoid"))
c_5 <- left_join(x = c_5, y = pop, by = c("county_id" = "geoid")) ##Added for Officer_initiated_stops

####################### ADD STATE DATA #####################################
s_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_incarceration_state_2025"))
s_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_perception_of_safety_state_2025"))
s_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_status_offenses_state_2025"))
s_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_use_of_force_state_2025"))
s_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_crim_officer_initiated_stops_state_2025")) ##Added for Officer_initiated_stops

# merge with urban type
region_urban_type <- dbGetQuery(con, paste0("SELECT geoid AS county_id, region, urban_type FROM v7.arei_multigeo_list"))

c_1 <- left_join(c_1, region_urban_type)
c_2 <- left_join(c_2, region_urban_type)
c_3 <- left_join(c_3, region_urban_type)
c_4 <- left_join(c_4, region_urban_type)
c_5 <- left_join(c_5, region_urban_type)

##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_indicator_list_cntyst"))

```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>PERFORMANCE: How well people are doing. The higher the circle, the better the performance.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.

# Key Findings

* Black Californians are significantly more likely to experience Law Enforcement Use of Force, with a rate 30.5x higher compared to other groups.

* Black Youth experience the greatest racial disparity in arrests for Status Offenses, being 2.6 times more likely to be arrested for these offenses compared to White Youth. 

* The majority of Californians (over 80%) generally feel safe in their neighborhoods. However, White, SWANA, and Those of Two or More Races (Non-Latinx) report feeling safer than the state average.

# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Two or More Races.

# Indicators

## Crime and Justice Index - UPDATED
```{r}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
 c_index_chart <- c_index_z %>% mutate(
    disp_z_cap = case_when(
      crime_and_justice_disparity_z > 2 ~ 2,
      crime_and_justice_disparity_z < -2 ~ -2,
      TRUE ~ crime_and_justice_disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      crime_and_justice_performance_z > 2 ~ 2,
      crime_and_justice_performance_z < -2 ~ -2,
      TRUE ~ crime_and_justice_performance_z)
    ) %>% filter(crime_and_justice_quadrant %in% c("yellow", "orange", "red", "purple"))

 c_index_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=crime_and_justice_quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.crime_and_justice_performance_rank} <br><strong>Disparity Rank: </strong>{point.crime_and_justice_disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f}")) %>%
  hc_title(text = "Crime and Justice Index") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 2, min = -2) %>%     ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 2, min = -2) %>%   ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_caption(
    text = "Data source: Various <br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes.",
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```

* Four out of six Southern California counties are in the Purple Quadrant (Higher Performance, Lower Disparity). San Bernardino County experiences lower performance and lower racial disparity rates, while Los Angeles County experiences lower performance and higher racial disparity rates.


## Incarceration - NOT UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_1_chart <- c_1 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

 c_1_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>API Rate: </strong>{point.nh_api_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f}")) %>%
  hc_title(text = "Incarcerations per 100k Persons") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Incarceration"]), 
    "<br>Total jail population is defined as the average daily number of people held in jail", 
    "<br>through December 31 of a given year. It includes individuals held under federal and other authorities.", 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* Los Angeles ranks among the counties with the most racial disparity (rank of 3) but has higher performance - meaning a lower overall incarceration rate - (rank of 10).
* Sutter is the only county in the Red Quadrant (Higher Disparity, Lower Performance). Black Californians are 153 times more likely to be incarcerated as the group with the lowest rate, leading to Sutter being the second most disparate county in the state on this measure.
* In Yolo County, with the worst racial disparities for incarceration, Black residents are 355 times more likely to be incarcerated as the group with the lowest rate.


### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Incarcerations per 100k Persons"

s_1_ <- s_1 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_1_long <- melt(s_1_, id.vars=c("state_name"))
s_1_long <- s_1_long[order(s_1_long$value),]
s_1_long <- s_1_long %>% mutate_if(is.double, ~round(., 1))

s_1_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_1$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_1$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

```  
* Black Californians are 19.5 times more likely to be incarcerated than the group with the lowest incarceration rate statewide. They are 1.8 times more likely to be incarcerated than even the group with the next highest rate (non-Latinx AIAN) indicating the extreme racial disparity facing this group.

### County Barchart

```{r}

c_1_long <- c_1 %>%
   select(c(2, ends_with('_rate')))

c_1_long <- melt(c_1_long, id.vars=c("county_name"))
c_1_long <- c_1_long[order(c_1_long$value),]
# Round 'value' field to 1 decimal
c_1_long <- c_1_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_1_long, key = ~ county_name)
title = "Incarcerations per 100k Persons"

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
          yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Perception of Safety - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_2_chart <- c_2 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_2_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Adults who Feel Safe in Their Neighborhood (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Perception of Safety"]), 
    "<br> Percentage of adults who reported feeling safe in their neighborhood all or most of the time.",
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```
* El Dorado County is the most racially disparate on this measure, with 56.1% of its Black residents having a much lower perception of safety than other groups within the county.

* Placer County has the highest perception of safety, but its NHPI residents report a much lower perception of safety compared to other groups within the county.


### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3

title = "Adults who Feel Safe in Their Neighborhood (%)"
s_2_ <- s_2 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_2_long <- melt(s_2_, id.vars=c("state_name"))
s_2_long <- s_2_long[order(-s_2_long$value),]
s_2_long <- s_2_long %>% mutate_if(is.double, ~round(., 1))

s_2_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_2$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_2$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

```
* More than 4 out of 5 Californians reported feeling safe in their neighborhood all or most of the time.

* Non-Hispanic Whites, those of Two or More Races (non-Latinx), and SWANA residents are the only groups who report feeling safer than the state average. 

### County Barchart

```{r}
c_2_long <- c_2 %>%
   select(c(1, ends_with('_rate')))

c_2_long <- melt(c_2_long, id.vars=c("county_name"))
c_2_long <- c_2_long[order(c_2_long$value),]
# Round 'value' field to 1 decimal
c_2_long <- c_2_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_2_long, key = ~ county_name)
title = "Adults who Feel Safe in Their Neighborhood (%)"

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),   # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Arrests for Status Offenses - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_3_chart <- c_3 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_3_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f}")) %>%
    hc_title(text = "Annual Average # of Arrests for Status Offenses per 10,000 Youth Under 18") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Arrests for Status Offenses"]), 
    "<br> A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)
```
* Nevada County is ranked the most disparate and among the lowest performing counties in the state for Youth Status Offense Arrests. 


### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
title = "Annual Average # of Arrests for Status Offenses per 10,000 Youth Under 18"
s_3_ <- s_3 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_3_long <- melt(s_3_, id.vars=c("state_name"))
s_3_long <- s_3_long[order(s_3_long$value),]
s_3_long <- s_3_long %>% mutate_if(is.double, ~round(., 1))

s_3_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
   hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_3$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_3$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

``` 
* Black Youth face by far the most racial disparity on this measure. They are 2.6 times more likely to be arrested for status offenses than White Youth. 


### County Barchart

```{r}

c_3_long <- c_3 %>%
   select(c(1, ends_with('_rate')))

c_3_long <- melt(c_3_long, id.vars=c("county_name"))
c_3_long <- c_3_long[order(c_3_long$value),]
# Round 'value' field to 1 decimal
c_3_long <- c_3_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd3 <- SharedData$new(c_3_long, key = ~ county_name)
title = "Annual Average # of Arrests for Status Offenses 
per 10,000 Youth Under 18"

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd3,
                ~ county_name, multiple = FALSE),
   plot_ly(sd3) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45, 
                          categoryorder = "total ascending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
                yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Use of Force - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_4_chart <- c_4 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_4_chart %>%
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:,.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:,.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:,.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:,.1f} <br><strong>API Rate: </strong>{point.api_rate:,.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:,.1f} ")) %>%
    hc_title(text = "Annual Average # of Civilians Subject to Law Enforcement Use of Force<br>per 100k People") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Use of Force"]), 
    "<br> A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```
* 9 out the 12 counties in the Red Quadrant (Higher Disparity, Lower Performance) are in the Northern/Sierra region. Note that we do expect to see somewhat more extreme higher and lower estimates in counties, like these, with smaller populations.



### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
title = "Annual Average # of Civilians Subject to Law Enforcement Use of Force per 100k People"
s_4_ <- s_4 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_4_long <- melt(s_4_, id.vars=c("state_name"))
s_4_long <- s_4_long[order(s_4_long$value),]
s_4_long <- s_4_long %>% mutate_if(is.double, ~round(., 1))

s_4_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_4$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_4$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


```
* Black Californians are 30.5 times more likely, and Pacific Islander Californians 27 times more likely, to be subject to Law Enforcement Use of Force than the group with the lowest rate. 

### County Barchart

```{r}

c_4_long <- c_4 %>%
   select(c(2, ends_with('_rate')))

c_4_long <- melt(c_4_long, id.vars=c("county_name"))
c_4_long <- c_4_long[order(c_4_long$value),]
# Round 'value' field to 1 decimal
c_4_long <- c_4_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd4 <- SharedData$new(c_4_long, key = ~ county_name)
title = "Annual Average # of Civilians Subject to 
Law Enforcement Use of Force per 100k People"

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd4,
                ~ county_name, multiple = FALSE),
   plot_ly(sd4) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),          # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
           yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols







```

## Officer-Initiated Stops - UPDATED {.tabset .tabset-fade}

### Scatterplot


```{r}

c_5_chart <- c_5 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("yellow", "orange", "red", "purple"))

c_5_chart %>%
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:,.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:,.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:,.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:,.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:,.1f} <br><strong>PI Rate: </strong>{point.nh_pacisl_rate:,.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:,.1f} ")) %>%
    hc_title(text = "Officer-Initiated Stops per 1,000 People") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Officer-Initiated Stops"]), 
    "<br> A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)



```
* Most counties are near average when it comes to performance for this measure.

* Alpine County is the most racially disparate for this measure and is also among the lowest performing because of its high rates of Officer-Initiated Stops for its Latinx and White residents.



### State Barchart

```{r}
title = "Officer-Initiated Stops per 1,000 People"

s_5_ <- s_5 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_5_long <- melt(s_5_, id.vars=c("state_name"))
s_5_long <- s_5_long[order(s_5_long$value),]
s_5_long <- s_5_long %>% mutate_if(is.double, ~round(., 1))

s_5_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_5$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_5$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "left")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

```
 * Pacific Islanders experience officer-initiated stops 2.3 times more than the state average and 6.1 times more than the group with the lowest rate. 
 

### County Barchart
```{r}
c_5_long <- c_5 %>%
   select(c(2, ends_with('_rate')))

c_5_long <- melt(c_5_long, id.vars=c("county_name"))
c_5_long <- c_5_long[order(c_5_long$value),]
# Round 'value' field to 1 decimal
c_5_long <- c_5_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html
# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd5 <- SharedData$new(c_5_long, key = ~ county_name)
title = "Officer-Initiated Stops per 1,000 People"

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd5,
                ~ county_name, multiple = FALSE),
   plot_ly(sd5) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total ascending"),          # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
           yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```

```{r}
##Disconnect from db
dbDisconnect(con)
dbDisconnect(con2)


``` 

```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-5) for a total of 6 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```


```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 }
window.onload = filter_default;
```




