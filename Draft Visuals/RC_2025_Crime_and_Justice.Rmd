---
title: "RACE COUNTS: Crime and Justice"
author: "Authored by: Catalyst California"
date: "8/25/2025"
output:
  html_document: 
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r include = FALSE}
#load the libraries via the below source as well as the credentials and set the theme
source("draft_visual_functions.R")
options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

##Add RC theme##
rc_theme # load from the above draft_visual_functions.R script
issue_name <- 'Safety & Justice' # Issue names: Safety & Justice, Democracy, Economic Opportunity, Education, Healthy Built Environment, Health Care Access, Housing
issue <- 'crim' #Issue: crim, demo, educ, econ, hben, hlth, hous
rc_schema <- 'v7'
rc_yr <- '2025'
acs_yr <- '2023'

```

```{r echo=FALSE, include = FALSE}
####################### GET COUNTY DATA #####################################
county_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%county_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

county_list <- dbGetQuery(con, county_list_query) %>% pull(table_name) 

c_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", county_list), county_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
c_tables <- map2(c_tables, names(c_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
c_tables <- lapply(c_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_county_', rc_yr), '', indicator),
         geolevel = 'county'))

# Get issue index
c_index_z <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_", issue, "_index_", rc_yr)) %>%
  rename(geo_name = county_name)  # make 'name' col generic

####################### POPULATION DATA #####################################
#Get total population
pop <- dbGetQuery(con, paste0("SELECT geoid, total_pop, geolevel FROM ", rc_schema, ".arei_race_multigeo WHERE geolevel = 'county'")) %>% select(-geolevel)

c_index_z <- left_join(c_index_z, pop, by = c("county_id" = "geoid"))

c_tables <- lapply(c_tables, function(x) 
  x %>% left_join(pop, by = c("county_id" = "geoid")))

## Make 'name' col generic
c_tables <- lapply(c_tables, function(x)
  x %>% rename(geo_name = county_name))

####################### GET STATE DATA #####################################
state_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%state_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

state_list <- dbGetQuery(con, state_list_query) %>% pull(table_name) 

s_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", state_list), state_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
s_tables <- map2(s_tables, names(s_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
s_tables <- lapply(s_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_state_', rc_yr), '', indicator),
         geolevel = 'state'))


##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_indicator_list_cntyst"))
v7_sources <- v7_sources %>% filter(v7_sources$arei_issue_area=="Crime & Justice") %>%
  select(arei_indicator, arei_issue_area, rate_descriptor, bar_chart_header, rate_rounding, methodology, data_source, api_name)


## Join metadata to data
c_tables <- lapply(c_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))
s_tables <- lapply(s_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))

names(c_tables)
names(s_tables)
```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>OUTCOME: How well people are doing. The higher the circle, the better the outcome.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.

# Key Findings

* Black Californians are significantly more likely to experience Law Enforcement Use of Force, with a rate 30.5x higher compared to other groups.

* Black Youth experience the greatest racial disparity in arrests for Status Offenses, being 2.6 times more likely to be arrested for these offenses compared to White Youth. 

* The majority of Californians (over 80%) generally feel safe in their neighborhoods. However, White, SWANA, and Those of Two or More Races (Non-Latinx) report feeling safer than the state average.

# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Two or More Races.

# Indicators

## Crime and Justice Index - UPDATED
```{r, echo=FALSE}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
  c_index_z <- c_index_z %>% mutate(arei_issue_area=issue_name)
  c_index_chart <- index_scatterplot(c_index_z, 2)

  c_index_chart

```

* Four out of six Southern California counties are in the Purple Quadrant (Higher Outcome, Lower Disparity). San Bernardino County experiences lower outcome and lower racial disparity rates, while Los Angeles County experiences lower outcome and higher racial disparity rates.


## Incarceration - NOT UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_1_chart <- county_scatterplot(c_tables[[1]])
c_1_chart


```
* Los Angeles ranks among the counties with the most racial disparity (rank of 3) but has higher outcome - meaning a lower overall incarceration rate - (rank of 10).
* Sutter is the only county in the Red Quadrant (Higher Disparity, Lower Outcome). Black Californians are 153 times more likely to be incarcerated as the group with the lowest rate, leading to Sutter being the second most disparate county in the state on this measure.
* In Yolo County, with the worst racial disparities for incarceration, Black residents are 355 times more likely to be incarcerated as the group with the lowest rate.


### State Barchart
```{r, echo=FALSE}
  s_1_ <- state_barchart(s_tables[[1]])
  s_1_

```  
* Black Californians are 19.5 times more likely to be incarcerated than the group with the lowest incarceration rate statewide. They are 1.8 times more likely to be incarcerated than even the group with the next highest rate (non-Latinx AIAN) indicating the extreme racial disparity facing this group.

### County Barchart

```{r, echo=FALSE}
c_1_long <- county_barchart(c_tables[[1]]) 
c_1_long
```


## Use of Force - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_2_chart <- county_scatterplot(c_tables[[2]])
c_2_chart
```



### State Barchart
```{r, echo=FALSE}
  s_2_ <- state_barchart(s_tables[[2]])
  s_2_

```
* More than 4 out of 5 Californians reported feeling safe in their neighborhood all or most of the time.

* Non-Hispanic Whites, those of Two or More Races (non-Latinx), and SWANA residents are the only groups who report feeling safer than the state average. 

### County Barchart

```{r, echo=FALSE}
c_2_long <- county_barchart(c_tables[[2]]) 
c_2_long
```


## Officer-Initiated Stops - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_3_chart <- county_scatterplot(c_tables[[3]])
c_3_chart
```
* Most counties are near average when it comes to outcome for this measure.

* Alpine County is the most racially disparate for this measure and is also among the lowest performing because of its high rates of Officer-Initiated Stops for its Latinx and White residents.


### State Barchart

```{r, echo=FALSE}
  s_3_ <- state_barchart(s_tables[[3]])
  s_3_

``` 
* Pacific Islanders experience officer-initiated stops 2.3 times more than the state average and 6.1 times more than the group with the lowest rate. 


### County Barchart

```{r, echo=FALSE}
c_3_long <- county_barchart(c_tables[[3]]) 
c_3_long
```


## Perception of Safety - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_4_chart <- county_scatterplot(c_tables[[4]])
c_4_chart

```
* El Dorado County is the most racially disparate on this measure, with 56.1% of its Black residents having a much lower perception of safety than other groups within the county.

* Placer County has the highest perception of safety, but its NHPI residents report a much lower perception of safety compared to other groups within the county.




### State Barchart

```{r, echo=FALSE}
  s_4_ <- state_barchart(s_tables[[4]])
  s_4_

```
* Black Californians are 30.5 times more likely, and Pacific Islander Californians 27 times more likely, to be subject to Law Enforcement Use of Force than the group with the lowest rate. 

### County Barchart

```{r, echo=FALSE}
c_4_long <- county_barchart(c_tables[[4]]) 
c_4_long
```

## Arrests for Status Offenses - UPDATED {.tabset .tabset-fade}

### Scatterplot


```{r, echo=FALSE}
c_5_chart <- county_scatterplot(c_tables[[5]])
c_5_chart
```
* Nevada County is ranked the most disparate and among the lowest performing counties in the state for Youth Status Offense Arrests.



### State Barchart

```{r, echo=FALSE}
  s_5_ <- state_barchart(s_tables[[5]])
  s_5_
```
 * Black Youth face by far the most racial disparity on this measure. They are 2.6 times more likely to be arrested for status offenses than White Youth. 
 

### County Barchart
```{r, echo=FALSE}
c_5_long <- county_barchart(c_tables[[5]]) 
c_5_long
```

```{r, echo=FALSE}
##Disconnect from db
dbDisconnect(con)
dbDisconnect(con2)


``` 

```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-5) for a total of 6 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```


```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 }
window.onload = filter_default;
```




