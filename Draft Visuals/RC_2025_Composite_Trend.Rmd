---
title: "RACE COUNTS: Small Pop Counties"
author: "Authored by: Catalyst California"
date: "9/27/23"
output:
  html_document:
    code_folding: hide
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Composite Index Trends'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}

</style>


```{r setup, include = FALSE}
## NOTE: Data viz below based on: W:\Project\RACE COUNTS\2022_v4\Visualizations\RC_2022_Indexes.RMD ###

knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

#Set up workspace
library(DT)
library(RPostgreSQL)
library(formattable)
library(knitr)
library(dplyr)
library(sf)
library(leaflet)
library(htmltools)
library(tidyr)
library(stringr)
library(rgdal)
library(rpostgis)
library(RColorBrewer)
library(ggplot2)
library(stringr)
library(scales)
library(colorspace)
library(highcharter)
library(here)
library(htmltools)
library(devtools)
library(broom)
library(kableExtra)
library(reshape2)
options(scipen=999)
options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))


setwd("W:/Project/RACE COUNTS/2023_v5/Visualizations/") 

# Load PostgreSQL driver and databases --------------------------------------------------
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("racecounts")
con2 <- connect_to_db("rda_shared_data")

# just a note of reference to inserting text #https://monashbioinformaticsplatform.github.io/2017-11-16-open-science-training/topics/rmarkdown.html
#https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf

```


```{r echo=FALSE, include = FALSE}

####################### ADD RC THEME #####################################
rc_theme <- hc_theme(
    # race counts colors
  colors = c("#800080", "orange", "red", "yellow"),
  chart = list(
    backgroundColor = "#F7F7F7", # RC white
    style = list(
          fontFamily = "Rubik") 
  ),
  title = list(
    style = list(
      color = "#070024",
      fontFamily = "Rubik")
  ),
  subtitle = list(
    style = list(
      color = "#8E8C8F", # medium grey
      fontFamily = "Rubik")
  ),
  caption = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
    axis = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
  legend = list(
    itemStyle = list(
      fontFamily = "Rubik",
      color = "#070024"),
    itemHoverStyle = list(
       fontFamily = "Rubik",
      color = "#070024")
  ))

# Add commas to long numbers
lang <- getOption("highcharter.lang")
lang$thousandsSep <- ","
options(highcharter.lang = lang)

####################### GET DATA #####################################
# Import index tables
## v5
v5_query <- "SELECT table_name FROM information_schema.tables WHERE table_schema='v5'"
rc_listv5 <- dbGetQuery(con, v5_query)
index_listv5 <- rc_listv5 %>% filter(grepl('index_2023',table_name))
index_listv5 <- index_listv5[order(index_listv5$table_name), ] # alphabetize list of index tables, changes df to list the needed format for next step
index_tablesv5 <- lapply(setNames(paste0("select * from v5.", index_listv5), index_listv5), DBI::dbGetQuery, conn = con)

## v4
v4_query <- "SELECT table_name FROM information_schema.tables WHERE table_schema='v4'"
rc_listv4 <- dbGetQuery(con, v4_query)
index_listv4 <- rc_listv4 %>% filter(grepl('index_2022',table_name))
index_listv4 <- index_listv4[order(index_listv4$table_name), ] # alphabetize list of index tables, changes df to list the needed format for next step
index_tablesv4 <- lapply(setNames(paste0("select * from v4.", index_listv4), index_listv4), DBI::dbGetQuery, conn = con)

## v3
v3_query <- "SELECT table_name FROM information_schema.tables WHERE table_schema='v3'"
rc_listv3 <- dbGetQuery(con, v3_query)
index_listv3 <- rc_listv3 %>% filter(grepl('index_2021',table_name))
index_listv3 <- index_listv3[order(index_listv3$table_name), ] # alphabetize list of index tables, changes df to list the needed format for next step
index_tablesv3 <- lapply(setNames(paste0("select * from v3.", index_listv3), index_listv3), DBI::dbGetQuery, conn = con)


# Join matching vintage total population to index tables
## v5
popv5 <- st_read(con2, query = "SELECT geoid AS county_id, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_2021")
index_pop_tablesv5 <- lapply(index_tablesv5, function(x) x%>% left_join(popv5, by='county_id'))

## v4
popv4 <- st_read(con2, query = "SELECT geoid AS county_id, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_2020")
index_pop_tablesv4 <- lapply(index_tablesv4, function(x) x%>% left_join(popv4, by='county_id'))

## v3
popv3 <- st_read(con2, query = "SELECT geoid AS county_id, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_2019")
index_pop_tablesv3 <- lapply(index_tablesv3, function(x) x%>% left_join(popv3, by='county_id'))


####################### DATA ANALYSIS #####################################
comp_index_list <-do.call(c, Map(list, index_pop_tablesv3[1], index_pop_tablesv4[1], index_pop_tablesv5[1]))
names(comp_index_list) <- c("composite_index_2021", "composite_index_2022", "composite_index_2023")
comp_index_list <- lapply(comp_index_list, transform, quadrant=ifelse(quadrant == "green", "purple", quadrant)) # update quadrant colors to match current colors

# Remove counties without quadrant values. Cap composite index perf/disp z-scores at 1 and -1. More info: https://catalystcalifornia.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
# set chart colors
hex_code <- c("#81007F", "#FADA5E", "#FA8128", "#CA3433")
quadrant <- c("purple", "yellow", "orange", "red")
quadrant_hex <- data.frame(hex_code, quadrant)

comp_index_list <- lapply(comp_index_list, function(x) x %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 1 ~ 1,
      disparity_z < -1 ~ -1,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 1 ~ 1,
      performance_z < -1 ~ -1,
      TRUE ~ performance_z)
    ) %>% left_join(
    quadrant_hex, by='quadrant'
    ) %>% filter(
    quadrant %in% c("purple", "yellow", "orange", "red")))

list2env(comp_index_list, envir = .GlobalEnv)
df_names <- as.data.frame(names(comp_index_list))   # get names of list elements to use in loop

# list of low pop counties in RED quadrant in v3-v5
small_pop <- lapply(comp_index_list, function(x) filter(x, dp05_0001e < 100000))
small_popv5 <- as.data.frame(small_pop[3]) %>% select(c(composite_index_2023.county_name, composite_index_2023.county_id, composite_index_2023.quadrant))
small_popv4 <- as.data.frame(small_pop[2]) %>% select(c(composite_index_2022.county_id, composite_index_2022.quadrant))
small_popv3 <- as.data.frame(small_pop[1]) %>% select(c(composite_index_2021.county_id, composite_index_2021.quadrant))

small_popall <- small_popv5 %>% left_join(small_popv4, by=c('composite_index_2023.county_id'='composite_index_2022.county_id')) 
small_popall <- small_popall %>% left_join(small_popv3, by=c('composite_index_2023.county_id'='composite_index_2021.county_id')) 
names(small_popall)[1] <- "County"
names(small_popall)[2] <- "County ID"
small_popall <- small_popall %>% as.data.frame() %>% arrange(County) %>% select(-c("County ID"))
#red_small_pop <- lapply(comp_index_list, function(x) filter(x, quadrant == "red" & dp05_0001e < 100000))

red_small <- data.frame(c(nrow(small_popall[small_popall$composite_index_2023.quadrant == 'red', ]), nrow(small_popall[small_popall$composite_index_2022.quadrant == 'red', ]), nrow(small_popall[small_popall$composite_index_2021.quadrant == 'red', ])))
RC_Version_Year <- data.frame(c("2023", "2022", "2021"))

small_popall_summary <- data.frame(c(RC_Version_Year, red_small))
names(small_popall_summary)[2] <- "# of Small Pop Red Counties"
names(small_popall_summary)[1] <- "RC_Year"

# join v3/v5 z-scores for potential further analysis
z_scores <- data.frame(index_pop_tablesv5[1]) 
colnames(z_scores) = gsub("arei_composite_index_2023.", "", colnames(z_scores))
z_scores <- z_scores %>% select(c(county_name, dp05_0001e, quadrant, ends_with("_z")))
#z_scores <- z_scores %>% left_join(composite_index_2022 %>% select(county_name, ends_with("_z")), by = "county_name", suffix=c(".v5", ".v4"))
z_scores <- z_scores %>% left_join(composite_index_2021 %>% select(county_name, ends_with("_z")), by = "county_name", suffix=c(".v5", ".v3"))



```

<!-- *** -->
# Summary
Looking at the composite index in 2021, there 9 (out of 21) counties with populations smaller than 100k (smaller pop counties) in the Red Quadrant. That number increased to 13 (out of 19) in 2022 and stayed at 13 (out of 18) in 2023. Behind that increase is the fact that 5 small pop counties (Colusa, Inyo, Plumas, Sutter, Tehama) moved into the Red Quadrant, while one (Mariposa) moved from Red into the Yellow Quadrant.

Looking at 2023 issue area indexes, we can see that there are many smaller pop counties in the Red Quadrant for Economic Opportunity and Democracy.

Note: All smaller population counties are in the Northern / Sierra region, except for San Benito in the Central Coast region.

# Data

## Composite Index 
```{r}

library(kableExtra)
small_popall_summary_sort <- small_popall_summary %>% arrange((RC_Year), descending = FALSE)  

summary <- kable(small_popall_summary_sort, digits=0, col.names=c("RC_Year","# of Small Pop Red Counties")) %>%
  kable_styling()%>%
    row_spec(1, bold = T, color ="white", background="#62bce5", extra_css = "border-bottom: 1px solid")%>%
    row_spec(2:3, bold=T, color= "white", background="#6c90ca", extra_css = "border-bottom: 1px solid")%>%
    add_header_above(c("Number of Counties with <100k Pop in Red Quadrant"=1," "=1), align="l")
summary

```

```{r}
counties <- kable(small_popall, digits=0, col.names=c("County", "2023.quadrant", "2022.quadrant", "2021.quadrant"))%>%
  kable_styling()%>%
    add_header_above(c("Counties with <100K Pop in 2023"=1," "=3), align="l") %>% 
  kable_material(c("striped"))
counties
```

```{r}

scatterplot <- function(table_name, title) {
scatter_ <- table_name %>%
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, color=hex_code),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f}")) %>%
  hc_title(text = (paste0("Composite Index ", title))) %>%
  hc_xAxis(title = list(text = "Disparity Z-Score"), max = 1.2, min = -1.2, tickInterval = .5) %>% 
  hc_yAxis(title = list(text = "Outcome Z-Score"), max = 1.2, min = -1.2, tickInterval = .5) %>% 
  hc_caption(
    text = "Data source: Various",
    align = "center"
     ) %>% hc_size(height=700,width=700)

  hc_add_theme(scatter_, rc_theme) 
  scatter_
}

v3 <- scatterplot(composite_index_2021, "2021")
v3


v4 <- scatterplot(composite_index_2022, "2022")
v4


v5 <- scatterplot(composite_index_2023, "2023")
v5

```
