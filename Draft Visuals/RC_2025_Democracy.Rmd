---
title: "RACE COUNTS: Democracy"
author: "Authored by: Catalyst California"
date: "8/25/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r include = FALSE}
### install version 1.1.1 of Crosstalk -- LATER VERSIONS OF CROSSTALK WILL NOT WORK ####
#remotes::install_version("crosstalk", version = "1.1.1", repos = "http://cran.us.r-project.org") 
# library(crosstalk)

#Set up workspace
packages <- c("crosstalk", "RPostgres", "sf", "htmltools", "tidyr", "reshape2", "plotly", "tidyverse", "highcharter")  

install_packages <- packages[!(packages %in% installed.packages()[,"Package"])] 

if(length(install_packages) > 0) { 
  install.packages(install_packages) 
  
} else { 
  
  print("All required packages are already installed.") 
} 

for(pkg in packages){ 
  library(pkg, character.only = TRUE) 
} 
options(scipen=999)

```


```{r setup, include = FALSE}

knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

# setwd("W:/Project/RACE COUNTS/2025_v7/Visualizations/") 

source("W:\\RDA Team\\R\\credentials_source.R") 
con <- connect_to_db("racecounts")

source("W:\\RDA Team\\R\\credentials_source.R") 
con2 <- connect_to_db("rda_shared_data")


# just a note of reference to inserting text #https://monashbioinformaticsplatform.github.io/2017-11-16-open-science-training/topics/rmarkdown.html
#https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf

```


```{r echo=FALSE, include = FALSE}

##Add RC theme##
rc_theme <- hc_theme(
    # race counts colors
  colors = c("orange", "purple", "red", "yellow"),
  chart = list(
    backgroundColor = "#FFFFFF",
    borderColor = "black",
    style = list(
          fontFamily = "Rubik") 
  ),
  title = list(
    style = list(
      color = "#070024",
      fontFamily = "Rubik")
  ),
  subtitle = list(
    style = list(
      color = "#8E8C8F", # medium grey
      fontFamily = "Rubik")
  ),
  caption = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
    axis = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
  legend = list(
    itemStyle = list(
      fontFamily = "Rubik",
      color = "#070024"),
    itemHoverStyle = list(
       fontFamily = "Rubik",
      color = "#070024")
  ))


lang <- getOption("highcharter.lang")
lang$thousandsSep <- ","
options(highcharter.lang = lang)

####################### ADD COUNTY DATA #####################################

c_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_census_participation_county_2025"))
c_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_diversity_of_candidates_county_2025"))
c_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_diversity_of_electeds_county_2025"))
c_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_registered_voters_county_2025"))
c_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_voting_midterm_county_2025"))
c_6 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_voting_presidential_county_2025"))

c_index_z <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_index_2025"))


####################### POPULATION DATA #####################################
#Join total population to index view, food access, and asthma data frames
pop <- dbGetQuery(con2, paste0("SELECT geoid, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_2023"))
#region_urban_type <- dbGetQuery(con, paste0("SELECT geo_id AS county_id, region, urban_type FROM v7.arei_multigeo_list")

c_index_z <- left_join(x = c_index_z, y = pop, by = c("county_id" = "geoid"))

c_4 <- left_join(x = c_4, y = pop, by = c("county_id" = "geoid"))
c_5 <- left_join(x = c_5, y = pop, by = c("county_id" = "geoid"))
c_6 <- left_join(x = c_6, y = pop, by = c("county_id" = "geoid"))


####################### ADD STATE DATA #####################################
s_1 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_census_participation_state_2025"))
s_2 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_diversity_of_candidates_state_2025"))
s_3 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_diversity_of_electeds_state_2025"))
s_4 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_registered_voters_state_2025"))
s_5 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_voting_midterm_state_2025"))
s_6 <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_demo_voting_presidential_state_2025"))

##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM v7.arei_indicator_list_cntyst"))

# merge with urban type
# region_urban_type <- dbGetQuery(con, paste0("SELECT geo_id AS county_id, region, urban_type FROM v4.arei_multigeo_list")
# c_1 <- left_join(c_1, region_urban_type)
# c_2 <- left_join(c_2, region_urban_type)
# c_3 <- left_join(c_3, region_urban_type)
# c_4 <- left_join(c_4, region_urban_type)
# c_5 <- left_join(c_5, region_urban_type)
# c_6 <- left_join(c_6, region_urban_type)  #Urban type join is no longer working with v4 data set and no 1to1 updated data set in v7 in postgres
```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>PERFORMANCE: How well people are doing. The higher the circle, the better the performance.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.


# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Two or More Races.

# Indicators

## Democracy Index - UPDATED
```{r}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
 c_index_chart <- c_index_z %>% mutate(
    disp_z_cap = case_when(
      democracy_disparity_z > 2 ~ 2,
      democracy_disparity_z < -2 ~ -2,
      TRUE ~ democracy_disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      democracy_performance_z > 2 ~ 2,
      democracy_performance_z < -2 ~ -2,
      TRUE ~ democracy_performance_z)
    ) %>% filter(democracy_quadrant %in% c("purple", "yellow", "orange", "red"))

 c_index_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=democracy_quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.democracy_performance_rank} <br><strong>Disparity Rank: </strong>{point.democracy_disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f}")) %>%
  hc_title(text = "Democracy Index") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 2, min = -2) %>%     ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 2, min = -2) %>%   ## this will need to be higher if disp or perf actual max value is (or close to) |2|
  hc_caption(
    text = "Data source: Various <br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes.",
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```

* There seems to be a correlation between higher performance and lower disparity.
* Generally, larger population counties have below average racial disparity while smaller population counties have higher than average disparity.
* All of the counties in the San Joaquin Valley besides Merced have below average performance in the Democracy Index.
* Nine of the 12 counties with the highest racial disparities in Democracy Index were in the Northern Sierra region.


## Census Participation {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_1_chart <- c_1 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

 c_1_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Other Rate: </strong>{point.nh_other_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
  hc_title(text = "Census Participation (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Census Participation"]), 
    "<br> A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
   hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```

* In general, larger population counties have higher overall Census participation rates than smaller population counties.
* 8 out of 9 Bay Area counties and 5 out of 6 Central Coast counties are in the purple Quadrant (Lower Disparity, Higher Performance). 
* The bottom 15 counties in census participation performance are all rural counties from the Northern Sierra region.

### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Census Participation (%)"
s_1_ <- s_1 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_1_long <- melt(s_1_, id.vars=c("state_name"))
s_1_long <- s_1_long[order(-s_1_long$value),]
s_1_long <- s_1_long %>% mutate_if(is.double, ~round(., 1))

s_1_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_1$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_1$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)

``` 

* At the state level, there is relatively little variation between the census participation rates of different racial groups. The lowest rate of any single racial group is just 1.6 percentage points below the overall statewide rate.
* Latinx, Black, and American Indian or Alaska Native Californians had the three lowest Census participation rates, while Asian Californians have the highest.


### County Barchart

```{r}

c_1_long <- c_1 %>%
   select(c(2, ends_with('_rate')))

c_1_long <- melt(c_1_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_1_long$value when MAX is best.
c_1_long <- c_1_long[order(-c_1_long$value),]
# Round 'value' field to 1 decimal
c_1_long <- c_1_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd1 <- SharedData$new(c_1_long, key = ~ county_name)
title = 'Census Participation (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:",  # this is what we want to see in the selection menu
                sd1,
                ~ county_name, multiple = FALSE),
   plot_ly(sd1) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
            plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ), 
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Diversity of Candidates - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_2_chart <- c_2 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_2_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>API Rate: </strong>{point.nh_api_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Candidates for Office of a Race per 100k Persons of That Race")  %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Diversity of Candidates"]), 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```

* All five counties in the purple Quadrant are in the Northern Sierra region.
* The fact that there is very little variance between counties in overall performance in this measure reflects that there is relatively equal proportional representation for each county across the various levels of government in California.
* Los Angeles County, which has the largest population, has the fourth lowest racial disparities among its body of candidates for public office.
* 7 of the 11 counties with the largest racial disparities in their elected representation are in the Bay Area.

### State Barchart
```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3

title = "Candidates of a Race per 100k Persons of That Race"
s_2_ <- s_2 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_2_long <- melt(s_2_, id.vars=c("state_name"))
s_2_long <- s_2_long[order(-s_2_long$value),]
s_2_long <- s_2_long %>% mutate_if(is.double, ~round(., 1))

s_2_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_2$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_2$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


```

* White Californians have by far the highest rate of representation among candidates for office, with 1.4 candidates per 100,000 residents. They are the only racial group in the entire state that have better representation than the overall statewide average.
* American Indian and Alaska Native Californians have the worst rate of representation among candidates for office of any racial group at just 0.2 officials per 100,000 people. They have 7x less representation than White Californians.
* Latinx Californians have nearly 3x less representation in the statewide candidate pool than White Californians.


### County Barchart

```{r}
c_2_long <- c_2 %>%
   select(c(county_name, ends_with('_rate')))

c_2_long <- melt(c_2_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_2_long$value when MAX is best.
c_2_long <- c_2_long[order(-c_2_long$value),]
# Round 'value' field to 1 decimal
c_2_long <- c_2_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd2 <- SharedData$new(c_2_long, key = ~ county_name)
title = 'Candidates of a Race per 100k Persons of That Race'

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd2,
                ~ county_name, multiple = FALSE),
   plot_ly(sd2) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width = 1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title,
                         titlefont = list(size = 11)
                        ),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Diversity of Elected Officials - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_3_chart <- c_3 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_3_chart %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=total_pop, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.total_pop:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.nh_aian_rate:.1f} <br><strong>API Rate: </strong>{point.nh_api_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Elected Officials of a Race per 100k Persons of That Race") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Diversity of Elected Officials"]), 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_colors(c("orange", "red", "yellow")) %>%   # custom colors added bc there are no bubbles in purple quadrant for this indicator in v7
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```

* The fact that there is very little variance between counties in overall performance in this measure reflects that there is relatively equal proportional representation for each county across the various levels of government in California.
* Many of the counties with larger populations, such as Sacramento, San Diego, Orange, Fresno, and Los Angeles, rank towards the lower end of racial disparities among their elected officials
* The 12 counties with the highest racial disparities in elected representation are all non-urban counties in the Northern Sierra region.

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Elected Officials of a Race per 100k Persons of That Race"
s_3_ <- s_3 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_3_long <- melt(s_3_, id.vars=c("state_name"))
s_3_long <- s_3_long[order(-s_3_long$value),]
s_3_long <- s_3_long %>% mutate_if(is.double, ~round(., 1))

s_3_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_3$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_3$total_rate, 1)), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)



``` 

* The disparity between White representation and the representation of all other racial groups in California is even wider in the statewide pool of elected than it is in the pool of candidates for office. This means White candidates are not just more likely to run, but more likely to win.


### County Barchart

```{r}

c_3_long <- c_3 %>%
   select(c(2, ends_with('_rate')))

c_3_long <- melt(c_3_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_3_long$value when MAX is best.
c_3_long <- c_3_long[order(-c_3_long$value),]
# Round 'value' field to 1 decimal
c_3_long <- c_3_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long
sd3 <- SharedData$new(c_3_long, key = ~ county_name)
title = "Elected Officials of a Race<br>per 100k Persons of That Race"


#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd3,
                ~ county_name, multiple = FALSE),
   plot_ly(sd3) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),     # Change to "total ascending" when MIN is best or "total descending" when MAX is best
            
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Registered Voters - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
c_4_chart <- c_4 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_4_chart %>%
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Registered Voters (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4, breakSize = 2) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Registered Voters"]), 
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)


```

* There appears to be a relationship between higher performance and lower disparity, meaning as registration goes up, disparity decreases.
* All but one of the San Joaquin Valley counties have lower than average voter registration rates. In fact, five of the eight counties with the lowest registration rates are in that region.

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3 

title = "Registered Voters (%)"
s_4_ <- s_4 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_4_long <- melt(s_4_, id.vars=c("state_name"))
s_4_long <- s_4_long[order(-s_4_long$value),]
s_4_long <- s_4_long %>% mutate_if(is.double, ~round(., 0))    # Round 'value' field to 0 decimals for this indicator only

s_4_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title), 
           plotLines = list(
                list(
                  value = s_4$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                    # the next line has extra code (label_comma) to add $ prefix and thousands separator - applies only for per capita income
                  label = list(text = paste0("Total Rate: ",round(s_4$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%

  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_add_theme(rc_theme)


```

* White voters have the best registration rate in the state, with 72% of eligible White Californians registered to vote.
* Latinx and Asian Californians have the worst rate of voter registration in the state at 55%, a rate 17 percentage points lower than the White rate (71%).
* Black Californians are registered to vote at a rate (63%) on par with the overall statewide rate (63.6%).

### County Barchart

```{r}


c_4_long <- c_4 %>%
   select(c(2, ends_with('_rate')))

c_4_long <- melt(c_4_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_4_long$value when MAX is best.
c_4_long <- c_4_long[order(-c_4_long$value),]
# Round 'value' field to 1 decimal
c_4_long <- c_4_long %>% mutate(value = round(value, 0)) 


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd4 <- SharedData$new(c_4_long, key = ~ county_name)
title = 'Registered Voters (%)'

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd4,
                ~ county_name, multiple = FALSE),
   plot_ly(sd4) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
            xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            # https://plotly-r.com/controlling-tooltips.html
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Voting in Midterm Elections {.tabset .tabset-fade}

### Scatterplot

```{r}
c_5_chart <- c_5 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_5_chart  %>% 
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f} <br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")) %>%
    hc_title(text = "Voting in Midterm Elections (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>% 
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>% 
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Voting in Midterm Elections"]),
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>% 
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```

* Five of the six counties in the Red Quadrant (Higher Disparity, Lower Performance) are in the San Joaquin Valley.
* Sonoma County has both the highest rates of voting in midterm elections in the state and the second lowest racial disparities in its midterm election voting pool.
* There is a general correlation between lower racial disparities and better overall voter turnout for midterm elections, with relatively few counties firmly in the yellow or orange quadrants. 


### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
title = "Voting in Midterm Elections (%)"
s_5_ <- s_5 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_5_long <- melt(s_5_, id.vars=c("state_name"))
s_5_long <- s_5_long[order(-s_5_long$value),]
s_5_long <- s_5_long %>% mutate_if(is.double, ~round(., 1))

s_5_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_5$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_5$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


```

* White voters are the most likely of any racial group in the state to turn out for midterm elections, voting at a rate 1.5 times higher than Asian and and Latinx voters.
* Asian and Latinx voters turn out at rates more than 10 percentage points below the statewide turnout rate.



### County Barchart

```{r}
c_5_long <- c_5 %>%
   select(c(county_name, ends_with('_rate')))

c_5_long <- melt(c_5_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_5_long$value when MAX is best.
c_5_long <- c_5_long[order(-c_5_long$value),]
# Round 'value' field to 1 decimal
c_5_long <- c_5_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long

sd5 <- SharedData$new(c_5_long, key = ~ county_name)
title = "Voting in Midterm Elections (%)"

#
bscols(
  widths = 7, 
  
   filter_select("county_name",  ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd5,
                ~ county_name, multiple = FALSE),
   plot_ly(sd5) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols


```


## Voting in Presidential Elections - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Remove counties without quadrant values. Cap indicator perf/disp z-scores at 3.5 and -3.5. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
c_6_chart <- c_6 %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 3.5 ~ 3.5,
      disparity_z < -3.5 ~ -3.5,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 3.5 ~ 3.5,
      performance_z < -3.5 ~ -3.5,
      TRUE ~ performance_z)
    ) %>% filter(quadrant %in% c("purple", "yellow", "orange", "red"))

c_6_chart %>% 
  hchart("scatter", 
    hcaes(x = disp_z_cap, y = perf_z_cap, size = dp05_0001e, group = quadrant),
    tooltip = list(pointFormat = 
      "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f} <br><strong>Total Rate: </strong>{point.total_rate:.1f} <br><strong>Latinx Rate: </strong>{point.latino_rate:.1f} <br><strong>Black Rate: </strong>{point.nh_black_rate:.1f} <br><strong>AIAN Rate: </strong>{point.aian_rate:.1f} <br><strong>NHPI Rate: </strong>{point.pacisl_rate:.1f}<br><strong>Asian Rate: </strong>{point.nh_asian_rate:.1f} <br><strong>White Rate: </strong>{point.nh_white_rate:.1f} <br><strong>Two or More Races Rate: </strong>{point.nh_twoormor_rate:.1f}")
  ) %>%
  hc_title(text = "Voting in Presidential Elections (%)") %>%
  hc_xAxis(title = list(text = "Disparity (Low -> High)"), max = 4, min = -4) %>%
  hc_yAxis(title = list(text = "Performance (Low -> High)"), max = 4, min = -4) %>%
  hc_caption(
    text = paste(
    "Data source:", 
    gsub(";", ";<br>", v7_sources$data_source[v7_sources$arei_indicator == "Voting in Presidential Elections"]),
    "<br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes."),
    align = "center"
  ) %>%
  hc_colors(c("orange", "red", "yellow", "purple")) %>% ## Manually entered in colors, changed up order til they were correct
  hc_legend(element_blank) %>%
  hc_add_theme(rc_theme)
       
      


```

* Data is relatively sparse for this indicator, as both the performance and disparity measures can only be reported for 26 of the 54 counties in the state.
* There appears to be a negative relationship between performance and disparity, meaning as disparity increases, voter turnout decreases.
* The three most disparate counties, Stanislaus, Kings, and Imperial, have large gaps between White and Latinx voter turnout.
* Six of the eight counties with the worst voter turnout rates are in the San Joaquin Valley.

### State Barchart

```{r}
# Be sure to update title above depending on if indicator has been updated since RC v3
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate
title = "Voting in Presidential Elections (%)"
s_6_ <- s_6 %>%
   select(c(state_name, ends_with('_rate'), -total_rate))
s_6_long <- melt(s_6_, id.vars=c("state_name"))
s_6_long <- s_6_long[order(-s_6_long$value),]
s_6_long <- s_6_long %>% mutate_if(is.double, ~round(., 1))

s_6_long %>% 
  hchart("column", 
    hcaes(x='variable', y='value'), color = "yellow", borderColor = "black") %>%
  hc_yAxis(title = list(text=title),  
           plotLines = list(
                list(
                  value = s_6$total_rate,
                  color = "black",
                  width = 2,
                  zIndex = 20,  # the higher number means will be top/most visible layer
                  label = list(text = paste0("Total Rate: ",round(s_6$total_rate, 1),"%"), style = list(color = "black", fontSize = 16), align = "right")))) %>%
  hc_tooltip(followPointer = TRUE) %>%  # extra line so that tooltip isn't hidden behind total_rate line
  hc_xAxis(title = list(text="Race/Ethnicity"), labels = (list(rotation = -45))) %>%
  hc_size(height=400, width=700) %>% hc_add_theme(rc_theme)


``` 

* White Californians have the highest turnout rate in the state for presidential elections, voting a rate well above the state average.
* Although White voter rates are still the highest, the differences in voting rates between racial groups in the state is less pronounced for presidential elections than it is for midterm elections. For presidential elections, white turnout is two percentage points closer to the statewide rate and 1.8 points closer to the racial group with the lowest rate (Latinx Californians).
* Asian voters increase their turnout by 17 percentage points for presidential elections compared to midterm elections.

### County Barchart

```{r}
c_6_long <- c_6 %>%
   select(c(2, ends_with('_rate')))

c_6_long <- melt(c_6_long, id.vars=c("county_name"))
# Be sure to order bars in ascending or descending depending on whether MIN or MAX is best rate. Add a "-" in front of c_6_long$value when MAX is best.
c_6_long <- c_6_long[order(-c_6_long$value),]
# Round 'value' field to 1 decimal
c_6_long <- c_6_long %>% mutate(value = round(value, 1))


# drop down selection menu for counties: check out this helpful resource https://rstudio.github.io/crosstalk/using.html

# create a shared data object from the df and assign a key for the unique observation. County is fine since each race/group has one unique county. from now on, we will be using the shareddata object and not the df_long


sd6 <- SharedData$new(c_6_long, key = ~ county_name)
title = "Voting in Presidential Elections (%)"

#
bscols(
  widths = 7, 
  
   filter_select("county_name", ## this is the name of column we want to select. 
                "County:", # this is what we want to see in the selection menu
                sd6,
                ~ county_name, multiple = FALSE),
   plot_ly(sd6) %>%
      add_trace(x = ~ variable, y = ~ value, type = "bar", color = I("yellow"), 
                marker = list(line = list(color = "black", width =1)) ## add order t
                ) %>%
     layout(barmode = "stack",
             xaxis = list(title = 'Race/Ethnicity',
                          tickangle=-45,
                          categoryorder = "total descending"),
            
            yaxis = list(title = title),
            
            
             width = 600,
            paper_bgcolor = "#FFFFFF",
             plot_bgcolor = "#FFFFFF",
            
            font = list(
              family = "Rubik",
              size = 12,
              color = '#8E8C8F'
             ),
            hoverlabel = list(bgcolor = "FFFFFF")
   ) # end layout
) # end bscols

```

```{r}
##Closing database connections##
dbDisconnect(con)
dbDisconnect(con2)
```


```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 }
window.onload = filter_default;
```




