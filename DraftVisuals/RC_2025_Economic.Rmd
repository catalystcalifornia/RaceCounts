---
title: "RACE COUNTS: Economic Opportunity"
author: "Authored by: Catalyst California"
date: "9/29/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r include = FALSE}
knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

#load the libraries via the below source as well as the credentials and set the theme
source("draft_visual_functions.R")

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

##Add RC theme##
rc_theme # load from the above draft_visual_functions.R script
issue_name <- 'Economic Opportunity' # Issue names: Safety & Justice, Democracy, Economic Opportunity, Education, Healthy Built Environment, Health Care Access, Housing
issue <- 'econ' #Issue: crim, demo, educ, econ, hben, hlth, hous
rc_schema <- 'v7'
rc_yr <- '2025'

```

```{r include = FALSE}
####################### GET COUNTY DATA #####################################
county_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%county_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

county_list <- dbGetQuery(con, county_list_query) %>% pull(table_name) 

c_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", county_list), county_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
c_tables <- map2(c_tables, names(c_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
c_tables <- lapply(c_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_county_', rc_yr), '', indicator),
         geolevel = 'county'))

# Get issue index
c_index_z <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_", issue, "_index_", rc_yr)) %>%
  rename(geo_name = county_name)  # make 'name' col generic

####################### POPULATION DATA #####################################
#Get total population
pop <- dbGetQuery(con, paste0("SELECT geoid, total_pop, geolevel FROM ", rc_schema, ".arei_race_multigeo WHERE geolevel = 'county'")) %>% select(-geolevel)

c_index_z <- left_join(c_index_z, pop, by = c("county_id" = "geoid"))

c_tables <- lapply(c_tables, function(x) 
  x %>% left_join(pop, by = c("county_id" = "geoid")))

## Make 'name' col generic
c_tables <- lapply(c_tables, function(x)
  x %>% rename(geo_name = county_name))

####################### GET STATE DATA #####################################
state_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%state_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

state_list <- dbGetQuery(con, state_list_query) %>% pull(table_name) 

s_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", state_list), state_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
s_tables <- map2(s_tables, names(s_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
s_tables <- lapply(s_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_state_', rc_yr), '', indicator),
         geolevel = 'state'))


##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_indicator_list_cntyst"))
v7_sources <- v7_sources %>% filter(v7_sources$arei_issue_area==issue_name) %>%
  select(arei_indicator, arei_issue_area, rate_descriptor, bar_chart_header, rate_rounding, methodology, data_source, api_name)


## Join metadata to data
c_tables <- lapply(c_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))
s_tables <- lapply(s_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))

names(c_tables)
names(s_tables)
```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>OUTCOME: How well people are doing. The higher the circle, the better the outcome.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.


# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "NH_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "two_or_more" group represents those who identify as Two or More Races.

# Indicators

## Economic Opportunity Index - UPDATED {.tabset .tabset-fade}
```{r, echo=FALSE}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
  c_index_z <- c_index_z %>% mutate(arei_issue_area=issue_name)
  c_index_chart <- index_scatterplot(c_index_z, 2)

  c_index_chart
```

* There appears to be a relationship between better Economic Opportunity outcomes and lower racial disparity.
* Overall, higher population counties have lower racial disparity and better outcomes than smaller population counties.
* All San Joaquin Valley counties have lower than average (worse) outcomes, with most having higher than average disparity as well. 
* All Bay Area counties have better than average outcomes with lower levels of disparity on the Economic Opportunity Index, except for Napa and San Francisco which have higher disparity.
* Among the top 10 counties with the best overall outcomes on Economic Opportunity, eight are in the Bay Area. In fact, Bay Area counties occupy ranks 1-6.

## Per Capita Income - UPDATED {.tabset .tabset-fade}


### Scatterplot

```{r, echo=FALSE} 
c_1_chart <- county_scatterplot(c_tables[[1]])
c_1_chart

```
* Los Angeles County has the 10th worst racial disparity on this measure. Non-Latinx White per capita income is 2.8x higher than that of Latinx residents and 2.5x higher than AIAN residents.
* San Francisco County has the secnd best outcome (highest per capita income) and the third worst disparities on this measure. The Non-Latinx White per capita income is 4.1x higher than AIAN income, and ~2.8x higher than NHPI and BLack residents' income.
* In four counties, all in the Bay Area, non-Latinx White per capita income is above $100k (SF, San Mateo, Marin, and Santa Clara).

### State Barchart
```{r, echo=FALSE}
  s_1_ <- state_barchart(s_tables[[1]])
  s_1_

``` 
* Statewide, only non-Latinx White and Asian residents have per capita incomes above the state average ($47,977).
* Another Race, Latinx, and AIAN residents have the lowest per capita incomes among all groups.

### County Barchart

```{r, echo=FALSE}
c_1_long <- county_barchart(c_tables[[1]]) 
c_1_long
```


## Internet Access - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE} 
c_2_chart <- county_scatterplot(c_tables[[2]])
c_2_chart

```
* There seems to be a relationship between better outcomes (more internet access) and lower racial disparity.
* More populous counties have better internet access (outcomes) and less racial disparity than less populous counties.
* Six of the top 10 counties with the best internet access (outcomes) are in the Bay Area.

### State Barchart
```{r, echo=FALSE}
  s_2_ <- state_barchart(s_tables[[2]])
  s_2_

``` 
* At the state level, disparity is relatively lower. The lowest (worst) rate among all groups is less than 3 percentage points below the average rate.

### County Barchart

```{r, echo=FALSE}
c_2_long <- county_barchart(c_tables[[2]]) 
c_2_long
```


## Living Wage - UPDATED {.tabset .tabset-fade}


### Scatterplot

```{r, echo=FALSE} 
c_3_chart <- county_scatterplot(c_tables[[3]])
c_3_chart
```
* Four of the top 10 most disparate counties on this measure are in the San Joaquin Valley (Stanislaus, Tulare, Fresno, and Merced). Those four counties also have below average outcomes.
* Eight of the top 10 best outcome counties on this measure are in the Bay Area, the other two are in the Sacramento area (Placer and El Dorado). SF, Santa Clara, and San Mateo are ranked 1-3. 

### State Barchart
```{r, echo=FALSE}
  s_3_ <- state_barchart(s_tables[[3]])
  s_3_

``` 
* In California, employers are least likely to pay Latinx, AIAN, and Black workers a living wage. These three groups are the only ones with rates that are worse than the state average.
* 85.3% of non-Latinx White workers earn a living wage compared to just 70.5% of Latinx workers.

### County Barchart

```{r, echo=FALSE}
c_3_long <- county_barchart(c_tables[[3]]) 
c_3_long
```


## Connected Youth - UPDATED {.tabset .tabset-fade}


### Scatterplot

```{r, echo=FALSE} 
c_4_chart <- county_scatterplot(c_tables[[4]])
c_4_chart

```
* There seems to be a connection between less racial disparity and better outcomes on this measure.
* Six of the top 10 most disparate counties are in the San Joaquin Valley, with Madera and Tulare ranked first and second respectively.
* All of the top 10 best outcome counties are semi-urban or urban. Four of them are in the Bay Area and three in the Central Coast.

### State Barchart
```{r, echo=FALSE}
  s_4_ <- state_barchart(s_tables[[4]])
  s_4_

``` 
* In California, Black, NHPI, and AIAN youth are least likely to be connected (in school and/or employed).

### County Barchart

```{r, echo=FALSE}
c_4_long <- county_barchart(c_tables[[4]]) 
c_4_long
```


## Officials & Managers - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE} 
c_5_chart <- county_scatterplot(c_tables[[5]])
c_5_chart

```
* Five of the 10 most disparate counties on this measure are in the San Joaquin Valley. There are also three Central Coast counties with San Luis Obispo ranked #1.
* Imperial County is ranked second most disparate (and has the worst overall outcome) because employers are 3.7x more likely to employ non-Latinx White workers as officials/managers than Latinx workers.
* The below average disparity counties are mainly clustered just below average due to Shasta alone having much higher disparity; while the above average disparity counties have a bit more variation.
* There seems to be some relationship between less disparity and better outcomes on this measure.


### State Barchart
```{r, echo=FALSE}
  s_5_ <- state_barchart(s_tables[[5]])
  s_5_

``` 
* Latinx, AIAN, and Black Californians are least likely to be employed as officials/managers by employers. 

### County Barchart

```{r, echo=FALSE}
c_5_long <- county_barchart(c_tables[[5]]) 
c_5_long
```



## Employment - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE} 

c_6_chart <- county_scatterplot(c_tables[[6]])
c_6_chart

```
* There seems to be a relationship between lower disparity and better outcomes on employment.
* Larger population counties have better outcomes than lower population counties in general.
* Los Angeles County has the third lowest disparity in the state and the 11th best outcome.

### State Barchart
```{r, echo=FALSE}
  s_6_ <- state_barchart(s_tables[[6]])
  s_6_

``` 
* Statewide, Latinx Californians are the most likely to be employed.
* Black and non-Latinx White Californians are less likely to be employed than the average state resident.

### County Barchart

```{r, echo=FALSE}
c_6_long <- county_barchart(c_tables[[6]]) 
c_6_long
```



## Real Cost Measure - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE} 


c_7_chart <- county_scatterplot(c_tables[[7]])
c_7_chart

```
* There seems to be a slight relationship between lower disparity and better outcomes on this measure.
* Five of the top 10 most disparate counties on this measure are in the San Joaquin Valley, the rest are in the Central Coast and Bay Area.
* Seven of the top 10 best outcome counties on this measure are in the Bay Area.

### State Barchart
```{r, echo=FALSE}
  s_7_ <- state_barchart(s_tables[[7]])
  s_7_

``` 
* Latinx and non-Latinx Black families are most likely to earn less than the cost-of-living adjusted poverty level. 
* Fewer than half of Latinx families (48.5%) earn above the adjusted poverty level.
* Only non-Latinx White and non-Latinx API families earn above the adjusted poverty level.

### County Barchart

```{r, echo=FALSE}
c_7_long <- county_barchart(c_tables[[7]]) 
c_7_long
```


```{r, echo=FALSE}
##Disconnect from database
dbDisconnect(con)
dbDisconnect(con2)

```

```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-5) for a total of 6 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```
Warning: Specifying width/height in layout() is now deprecated.
Please specify in ggplotly() or plot_ly()Warning: Sum of bscol width units is greater than 12Warning: Ignoring 241 observationsWarning: Ignoring 241 observations> 

```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[6].selectize.setValue("Alameda", false);
 }
window.onload = filter_default;
```




