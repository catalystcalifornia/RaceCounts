---
title: "RACE COUNTS: Healthy Built Environment"
author: "Authored by: Catalyst California"
date: "9/16/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

#load the libraries via the below source as well as the credentials and set the theme
source("draft_visual_functions.R")

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

##Add RC theme##
rc_theme # load from the above draft_visual_functions.R script

##### UPDATE EACH YEAR AND FOR EACH ISSUE AREA ####
issue_name <- 'Healthy Built Environment' # Issue names: Safety & Justice, Democracy, Economic Opportunity, Education, Healthy Built Environment, Health Care Access, Housing
issue <- 'hben' #Issue: crim, demo, educ, econ, hben, hlth, hous
rc_schema <- 'v7'
rc_yr <- '2025'
acs_yr <- '2023'

```

```{r echo=FALSE, include = FALSE}

####################### GET COUNTY DATA #####################################
county_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%county_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

county_list <- dbGetQuery(con, county_list_query) %>% pull(table_name) 

c_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", county_list), county_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
c_tables <- map2(c_tables, names(c_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
c_tables <- lapply(c_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_county_', rc_yr), '', indicator),
         geolevel = 'county'))

# Get issue index
c_index_z <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_", issue, "_index_", rc_yr)) %>%
  rename(geo_name = county_name)  # make 'name' col generic

####################### POPULATION DATA #####################################
#Get total population
pop <- dbGetQuery(con, paste0("SELECT geoid, total_pop, geolevel FROM ", rc_schema, ".arei_race_multigeo WHERE geolevel = 'county'")) %>% select(-geolevel)

c_index_z <- left_join(c_index_z, pop, by = c("county_id" = "geoid"))

c_tables <- lapply(c_tables, function(x) 
  x %>% left_join(pop, by = c("county_id" = "geoid")))

## Make 'name' col generic
c_tables <- lapply(c_tables, function(x)
  x %>% rename(geo_name = county_name))

####################### GET STATE DATA #####################################
state_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%state_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

state_list <- dbGetQuery(con, state_list_query) %>% pull(table_name) 

s_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", state_list), state_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
s_tables <- map2(s_tables, names(s_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
s_tables <- lapply(s_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_state_', rc_yr), '', indicator),
         geolevel = 'state'))


##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_indicator_list_cntyst"))
v7_sources <- v7_sources %>% filter(v7_sources$arei_issue_area==issue_name) %>%
  select(arei_indicator, arei_issue_area, rate_descriptor, bar_chart_header, rate_rounding, methodology, data_source, api_name)


## Join metadata to data
c_tables <- lapply(c_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))
s_tables <- lapply(s_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))

names(c_tables)
names(s_tables)
```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>OUTCOME: How well people are doing. The higher the circle, the better the outcome.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.


# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Two or More Races.

# Indicators

## Healthy Built Environment Index - UPDATED
```{r, echo=FALSE}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
   c_index_z <- c_index_z %>% mutate(arei_issue_area=issue_name)
  c_index_chart <- index_scatterplot(c_index_z, 2)

  c_index_chart
```
* The four counties in the Red Quadrant (Higher Disparity, Lower Outcome) with the worst outcome measures are all in the San Joaquin Valley.
* Los Angeles County has the worst outcome out of all 46 counties ranked on the healthy built environment index.
* The Central Coast seems to be the region with the healthiest and least racially disparate built environments in the state. Of the six counties in the region, there are five with better than average outcome and five with below average racial disparities.

<!--## Healthy Built Environment Index - UPDATED (Percentile) -->

<!--```{r, echo=FALSE}
c_index_pctile %>% 
  filter(quadrant %in% c("purple", "yellow", "orange", "red")) %>%
    hchart("scatter", 
    hcaes(x=healthy_built_environment_disparity_pctile, y=healthy_built_environment_performance_pctile, size=dp05_0001e, group=quadrant),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Performance Rank: </strong>{point.healthy_built_environment_performance_rank} <br><strong>Disparity Rank: </strong>{point.healthy_built_environment_disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f}")) %>%
  hc_title(text = "Healthy Built Environment Index Percentile") %>%
  hc_xAxis(title = list(text = "Disparity Percentile"), max = 1, min = -0.1) %>% 
  hc_yAxis(title = list(text = "Performance Percentile"), max = 1.1, min = 0) %>% 
  hc_caption(
    text = "Data source: Various <br>A Disparity Rank of 1 represents the most disparate. A Performance Rank of 1 represents the best outcomes.",
    align = "center"
     ) %>% #hc_size(height=400,width=700) %>%
  hc_legend(element_blank) %>% hc_add_theme(rc_theme)

```-->


## Drinking Water Contaminants - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_1_chart <- county_scatterplot(c_tables[[1]])
c_1_chart
```

* Counties with larger populations tend to have less than average racial disparity, while all of the counties with the most disparity have smaller populations.
* Four of the Five counties in the Red Quadrant are from the San Joaquin Valley, meaning that region experiences above average levels of both drinking water contaminants and racial disparities in who in exposed to them.
* Los Angeles County ranks the 4th worst of all 56 California counties measured in overall levels of drinking water contaminants.

### State Barchart
```{r, echo=FALSE}
  s_1_ <- state_barchart(s_tables[[1]])
  s_1_
``` 

* Statewide, Latinx, Southwest Asian or North African, and American Indian or Alaska Native Californians are the three racial groups with more exposure to drinking water contaminants than the overall statewide rate.

### County Barchart

```{r, echo=FALSE}
c_1_long <- county_barchart(c_tables[[1]]) 
c_1_long
```


## Food Access {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_2_chart <- county_scatterplot(c_tables[[2]])
c_2_chart

```

* All six counties in the Central Coast region and eight of the nine counties in the Bay Area have better than average overall access to fresh fruits and vegetables. Racial disparities in this access vary across the two regions though, with roughly half the counties in each region in the Purple Quadrant (low disparity) and half in the Orange Quadrant (high disparity).
* All eight counties in the San Joaquin Valley have below average outcome in access to fresh foods, and five of the six counties in the Red Quadrant (low outcome, high disparity) are from the region.
* San Diego and Orange County have uniquely high rates of access to fresh food among Southern California counties, and are the only two counties from the region in the Purple Quadrant (high outcome, low disparity).

### State Barchart
```{r, echo=FALSE}
  s_2_ <- state_barchart(s_tables[[2]])
  s_2_

```

* White and multi-racial Californians are the only racial groups with access to fresh fruits and vegetables at a rate higher than the overall statewide rate.
* Black and Latinx Californians have the worst access to fresh fruits and vegetables of any racial group in the state, with their respective access rates eight and seven percentage points lower than that of White people.

### County Barchart

```{r, echo=FALSE}
c_2_long <- county_barchart(c_tables[[2]]) 
c_2_long
```


## Proximity to Hazards - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_3_chart <- county_scatterplot(c_tables[[3]])
c_3_chart
```

* There is a general negative correlation in California between county population size and the racial disparities in proximity to hazardous sites in that county. Meaning that, in general, larger population counties have less racial disparity on this indicator.
* Nevada and Amador Counties rank as the having the worst and second worst proximity to hazards scores (outcomes) statewide. Their scores are close to or more than double that of the third worst outcome county.
* In the counties with the four worst racial disparity scores, American Indian and Alaska Native residents live in the greatest proximity to hazardous sites. In two of these counties (Mono and Madera), AIAN folks are 2x more exposure to hazardous sites than the average county resident.

### State Barchart

```{r, echo=FALSE}
  s_3_ <- state_barchart(s_tables[[3]])
  s_3_
``` 

* Latinx and Southwest Asian or North African Californians face nearly 1.5 times more exposure to hazardous clean up sites than Whites, the group with the best rate. Black and Asian Californians also face exposure that is above the statewide rate.

### County Barchart

```{r, echo=FALSE}
c_3_long <- county_barchart(c_tables[[3]]) 
c_3_long
```


## Toxic Releases from Facilities - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_4_chart <- county_scatterplot(c_tables[[4]])
c_4_chart
```

* Los Angeles and Orange Counties have by far the lowest outcome (most exposure to toxic releases) among all California counties.
* The non-urban, northern counties of Mariposa and Siskiyou exhibit by far the highest racial disparities in those exposed to toxic releases from facilities. In Siskiyou County, Latinx residents are exposed to toxic releases at nearly 3x the overall county rate.
* Six of the eight counties with higher racial disparities are counties with populations around or below 50,000 residents.

### State Barchart

```{r, echo=FALSE}
  s_4_ <- state_barchart(s_tables[[4]])
  s_4_
```

* Black residents statewide face more than 2.5 times, and Latinx residents two times, as much exposure to toxic releases as White residents do.

### County Barchart

```{r, echo=FALSE}
c_4_long <- county_barchart(c_tables[[4]]) 
c_4_long
```


## Asthma - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_5_chart <- county_scatterplot(c_tables[[5]])
c_5_chart
```

* San Francisco has the second highest disparity rate in the state for asthma diagnoses behind only Mendocino County. American Indian or Alaska Native residents of the county are almost 3x as likely to be diagnosed with asthma than the average county resident.
* The Central Coast counties particularly stand out in this measure. Five of the six counties in the region are in the Purple Quadrant (high outcome, low disparity), with Monterey, Ventura, and Santa Barbara recording three of the four best asthma rates in the state.
* There is no data on asthma rates for 17 of the 25 counties in the Northern/Sierra region.

### State Barchart

```{r, echo=FALSE}
  s_5_ <- state_barchart(s_tables[[5]])
  s_5_
```

* All but one of the eight counties in the San Joaquin Valley have higher rates of asthma than average. Counties from the region represent more than half of the counties in the Red Quadrant (low outcome, high disparity).
* Southwest Asian or North African, Asian, and Latinx Californians have the lowest rates of asthma diagnoses in the state.
* More than one in five Black, American Indian or Alaska Native, Native Hawaiian or Pacific Islander, and Multiracial non-Latinx Californians have been diagnosed with asthma.

### County Barchart

```{r, echo=FALSE}
c_5_long <- county_barchart(c_tables[[5]]) 
c_5_long
```


## Lack of Green Space - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_6_chart <- county_scatterplot(c_tables[[6]])
c_6_chart
```
* The 10 counties with the lowest disparity also have worse outcomes (less greenspace).
* There is a strong negative correlation between greenspace and population size in counties. Only two of the top ten performing counties have more than 100,000 residents, while all counties with more than 300,000 residents had below average outcome.
* Los Angeles County ranks 55 out of 56 counties in greenspace.
* In Mendocino County, which ranks first for the most racial disparities in access to greenspace, white people have nearly 2x greater access to greenspaces than Latinx residents of the county.

### State Barchart

```{r, echo=FALSE}
  s_6_ <- state_barchart(s_tables[[6]])
  s_6_
``` 

* Black people have the least access to greenspaces of any racial group in California, with 54.5% of land in disproportionately Black neighborhoods covered by impenetrable surfaces. This rate is 14 percentage points higher than the rate for white people.
* Asian, Latinx, and Southwest Asian or North African Californians are also less likely to have access to greenspace than the average Californian.

### County Barchart

```{r, echo=FALSE}
c_6_long <- county_barchart(c_tables[[6]]) 
c_6_long
```

```{r, echo=FALSE, include = FALSE}
##Closing database connections##
dbDisconnect(con)
dbDisconnect(con2)

```


```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-5) for a total of 6 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```


```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 }
window.onload = filter_default;
```




