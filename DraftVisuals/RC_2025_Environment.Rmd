---
title: "RACE COUNTS: Healthy Built Environment"
author: "Authored by: Catalyst California"
date: "9/29/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

#load the libraries via the below source as well as the credentials and set the theme
source("draft_visual_functions.R")

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

##Add RC theme##
rc_theme # load from the above draft_visual_functions.R script

##### UPDATE EACH YEAR AND FOR EACH ISSUE AREA ####
issue_name <- 'Healthy Built Environment' # Issue names: Safety & Justice, Democracy, Economic Opportunity, Education, Healthy Built Environment, Health Care Access, Housing
issue <- 'hben' #Issue: crim, demo, educ, econ, hben, hlth, hous
rc_schema <- 'v7'
rc_yr <- '2025'

```

```{r echo=FALSE, include = FALSE}

####################### GET COUNTY DATA #####################################
county_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%county_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

county_list <- dbGetQuery(con, county_list_query) %>% pull(table_name) 

c_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", county_list), county_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
c_tables <- map2(c_tables, names(c_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
c_tables <- lapply(c_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_county_', rc_yr), '', indicator),
         geolevel = 'county'))

# Get issue index
c_index_z <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_", issue, "_index_", rc_yr)) %>%
  rename(geo_name = county_name)  # make 'name' col generic

####################### POPULATION DATA #####################################
#Get total population
pop <- dbGetQuery(con, paste0("SELECT geoid, total_pop, geolevel FROM ", rc_schema, ".arei_race_multigeo WHERE geolevel = 'county'")) %>% select(-geolevel)

c_index_z <- left_join(c_index_z, pop, by = c("county_id" = "geoid"))

c_tables <- lapply(c_tables, function(x) 
  x %>% left_join(pop, by = c("county_id" = "geoid")))

## Make 'name' col generic
c_tables <- lapply(c_tables, function(x)
  x %>% rename(geo_name = county_name))

####################### GET STATE DATA #####################################
state_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%state_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

state_list <- dbGetQuery(con, state_list_query) %>% pull(table_name) 

s_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", state_list), state_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
s_tables <- map2(s_tables, names(s_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
s_tables <- lapply(s_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_state_', rc_yr), '', indicator),
         geolevel = 'state'))


##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_indicator_list_cntyst"))
v7_sources <- v7_sources %>% filter(v7_sources$arei_issue_area==issue_name) %>%
  select(arei_indicator, arei_issue_area, rate_descriptor, bar_chart_header, rate_rounding, methodology, data_source, api_name)


## Join metadata to data
c_tables <- lapply(c_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))
s_tables <- lapply(s_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))

names(c_tables)
names(s_tables)
```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>OUTCOME: How well people are doing. The higher the circle, the better the outcome.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.


# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Multiracial.

# Indicators

## Healthy Built Environment Index - UPDATED
```{r, echo=FALSE}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
  c_index_z <- c_index_z %>% mutate(arei_issue_area=issue_name)
  c_index_chart <- index_scatterplot(c_index_z, 2)

  c_index_chart
```
* Seven of the 10 counties with the worst overall outcomes on the HBE Index are in the San Joaquin Valley, the other three are LA, Amador, and Sutter counties.
Los Angeles County has the worst outcome out of all 46 counties ranked on the healthy built environment index.
* All San Joaquin Valley counties have below average outcomes, though disparity varies. Madera and San Joaquin counties in particular have high disparities, ranked 5th and 6th most disparate respectively.


## Lack of Green Space - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_1_chart <- county_scatterplot(c_tables[[1]])
c_1_chart
```

* Counties with larger populations tend to have less than average racial disparity, while all of the counties with the most disparity have smaller populations.
* Los Angeles County ranks the 2nd worst of the 56 California counties measured in overall lack of green space.

### State Barchart
```{r, echo=FALSE}
  s_1_ <- state_barchart(s_tables[[1]])
  s_1_
``` 

* Statewide, Black, Asian, and Southwest Asian or North African Californians are the three racial groups with the least access to green space.

### County Barchart

```{r, echo=FALSE}
c_1_long <- county_barchart(c_tables[[1]]) 
c_1_long
```


## Toxic Releases - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_2_chart <- county_scatterplot(c_tables[[2]])
c_2_chart

```

* All Bay Area counties have better than average racial disparity on this measure.
* Madera County stands out as having the 3rd worst racial disparities and overall worst outcome on this indicator.
* LA County has the second worst outcome, meaning second highest exposure to toxic releases, among all counties.

### State Barchart
```{r, echo=FALSE}
  s_2_ <- state_barchart(s_tables[[2]])
  s_2_

```

* Black and Latinx Californians have the worst exposure to toxic releases among all racial groups in the state, with their respective exposure well above the average exposure level.

### County Barchart

```{r, echo=FALSE}
c_2_long <- county_barchart(c_tables[[2]]) 
c_2_long
```


## Proximity to Hazards - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_3_chart <- county_scatterplot(c_tables[[3]])
c_3_chart
```

* Amador and Nevada counties rank as the having the worst and second worst proximity to hazards scores (outcomes) statewide. Their scores are close to or more than double that of the third worst outcome county.
* Mono County has the worst racial disparities on this measure, its AIAN residents score is 2.4x higher than the average exposure score.

### State Barchart

```{r, echo=FALSE}
  s_3_ <- state_barchart(s_tables[[3]])
  s_3_
``` 

* Statewide, only non-Latinx White, Multiracial, and AIAN residents have below average (better) exposure scores than the average resident.

### County Barchart

```{r, echo=FALSE}
c_3_long <- county_barchart(c_tables[[3]]) 
c_3_long
```


## Drinking Water Contaminants - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_4_chart <- county_scatterplot(c_tables[[4]])
c_4_chart
```

* Alameda is the only urban county among the top 10 counties with the worst racial disparities on drinking water contaminants. However, it also has the best overall outcome on this measure.
* San Bernardino and Los Angeles counties are the only urban counties among the top 10 counties with the worst overall outcomes on this measure. They are both also relatively lower disparity counties.

### State Barchart

```{r, echo=FALSE}
  s_4_ <- state_barchart(s_tables[[4]])
  s_4_
```

* Latinx, SWANA, and AIAN Californians are the only groups with above average (worst) exposure to drinking water contaminants in California.

### County Barchart

```{r, echo=FALSE}
c_4_long <- county_barchart(c_tables[[4]]) 
c_4_long
```


## Asthma - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_5_chart <- county_scatterplot(c_tables[[5]])
c_5_chart
```

* San Luis Obispo has the second highest disparity rate in the state for asthma diagnoses behind only Placer County. American Indian or Alaska Native residents of the county are 1.8x as likely to be diagnosed with asthma than the average county resident.
* Los Angeles County has the fifth best (lowest) asthma rate, but also has the 9th worst racial disparities. LAC Multiracial, AIAN, Black, and NHPI residents have the highest asthma rates among all groups.
* There is data for only 8 of the 25 Northern / Sierra region counties.

### State Barchart

```{r, echo=FALSE}
  s_5_ <- state_barchart(s_tables[[5]])
  s_5_
```

* Asian, Southwest Asian or North African, and Latinx Californians have the lowest rates of asthma diagnoses in the state.
* About one in five Multiracial, AIAN, Black, and NHPI Californians have been diagnosed with asthma.

### County Barchart

```{r, echo=FALSE}
c_5_long <- county_barchart(c_tables[[5]]) 
c_5_long
```


## Food Access - NOT UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_6_chart <- county_scatterplot(c_tables[[6]])
c_6_chart
```
* The top ten counties with the lowest racial disparities on Food Access are all semi-urban and urban counties, except for El Dorado.
* The bottom ten counties with the worst racial disparities are also all semi-urban and urban counties. Four of them are in the Bay Area (Sonoma, San Francisco, Napa, and Santa Clara).


### State Barchart

```{r, echo=FALSE}
  s_6_ <- state_barchart(s_tables[[6]])
  s_6_
``` 

* Black and Latinx Californians have the least food access of any racial group.
* Only non-Latinx White and non-Latinx Multiracial residents have above average (better) food access than the average California resident.
* It is important to note that there are many ways to measure food access that may reveal different perspectives.


### County Barchart

```{r, echo=FALSE}
c_6_long <- county_barchart(c_tables[[6]]) 
c_6_long
```

```{r, echo=FALSE, include = FALSE}
##Closing database connections##
dbDisconnect(con)
dbDisconnect(con2)

```


```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-5) for a total of 6 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```


```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 }
window.onload = filter_default;
```




