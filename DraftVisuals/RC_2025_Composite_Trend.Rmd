---
title: "RACE COUNTS"
author: "Authored by: Catalyst California"
date: "9/25/25"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Composite Index Trends'
---
  
<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}

</style>


```{r setup, include = FALSE}
## NOTE: Data viz below based on: W:\Project\RACE COUNTS\2024_v6\Visualizations\RC_2024_Indexes.RMD ###

knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

#Set up workspace
packages <- c("DT","RPostgres","formattable","knitr","dplyr","sf","leaflet","htmltools","tidyr","stringr","rgdal","rpostgis","RColorBrewer","ggplot2","stringr","scales","colorspace","highcharter","here","htmltools","devtools","broom","kableExtra","reshape2")  

install_packages <- packages[!(packages %in% installed.packages()[,"Package"])] 

if(length(install_packages) > 0) { 
  install.packages(install_packages) 
  
} else { 
  
  print("All required packages are already installed.") 
} 

for(pkg in packages){ 
  library(pkg, character.only = TRUE) 
} 
options(scipen=999)
options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))


# Load PostgreSQL driver and databases --------------------------------------------------
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("racecounts")
con2 <- connect_to_db("rda_shared_data")

# set source for viz functions
source("draft_visual_functions.R")

##### UPDATE EACH YEAR ####
curr_schema <- 'v7'
curr_yr <- '2025'
prev_schema <- 'v6'
prev_yr <- '2024'
prev2_schema <- 'v5'
prev2_yr <- '2023'

# just a note of reference to inserting text #https://monashbioinformaticsplatform.github.io/2017-11-16-open-science-training/topics/rmarkdown.html
#https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf

```


```{r rc theme, echo=FALSE, include = FALSE}

####################### ADD RC THEME #####################################
rc_theme <- hc_theme(
    # race counts colors
  colors = c("#800080", "orange", "red", "yellow"),
  chart = list(
    backgroundColor = "#F7F7F7", # RC white
    style = list(
          fontFamily = "Rubik") 
  ),
  title = list(
    style = list(
      color = "#070024",
      fontFamily = "Rubik")
  ),
  subtitle = list(
    style = list(
      color = "#8E8C8F", # medium grey
      fontFamily = "Rubik")
  ),
  caption = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
    axis = list(
    style = list(
      color = "#8E8C8F",
      fontFamily = "Rubik")
  ),
  legend = list(
    itemStyle = list(
      fontFamily = "Rubik",
      color = "#070024"),
    itemHoverStyle = list(
       fontFamily = "Rubik",
      color = "#070024")
  ))

# Add commas to long numbers
lang <- getOption("highcharter.lang")
lang$thousandsSep <- ","
options(highcharter.lang = lang)

```


```{r load data, echo=FALSE, include = FALSE}

####################### GET DATA #####################################
# Import index tables
## 2 years prior version
prev2_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_schema='", prev2_schema, "'")
prev2_rc_list <- dbGetQuery(con, prev2_query)
prev2_index_list <- prev2_rc_list %>% filter(grepl(paste0('index_', prev2_yr),table_name))
prev2_index_list <- prev2_index_list[order(prev2_index_list$table_name), ] # alphabetize list of index tables, changes df to list the needed format for next step
prev2_index_tables <- lapply(setNames(paste0("select * from ", prev2_schema,".", prev2_index_list), prev2_index_list), DBI::dbGetQuery, conn = con)

## previous version
prev_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_schema='", prev_schema, "'")
prev_rc_list <- dbGetQuery(con, prev_query)
prev_index_list <- prev_rc_list %>% filter(grepl(paste0('index_', prev_yr),table_name))
prev_index_list <- prev_index_list[order(prev_index_list$table_name), ] # alphabetize list of index tables, changes df to list the needed format for next step
prev_index_tables <- lapply(setNames(paste0("select * from ", prev_schema,".", prev_index_list), prev_index_list), DBI::dbGetQuery, conn = con)

## current version
curr_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_schema='", curr_schema, "'")
curr_rc_list <- dbGetQuery(con, curr_query)
curr_index_list <- curr_rc_list %>% filter(grepl(paste0('index_', curr_yr),table_name))
curr_index_list <- curr_index_list[order(curr_index_list$table_name), ] # alphabetize list of index tables, changes df to list the needed format for next step
curr_index_tables <- lapply(setNames(paste0("select * from ", curr_schema, ".", curr_index_list), curr_index_list), DBI::dbGetQuery, conn = con)


# Join matching vintage total population to index tables
## 2 years previous version
prev2_pop_yr <- as.numeric(prev2_yr) -2
prev2_pop <- dbGetQuery(con2, paste0("SELECT geoid AS county_id, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_", prev2_pop_yr, " WHERE geolevel = 'county'"))
prev2_index_pop_tables <- lapply(prev2_index_tables, function(x) x%>% left_join(prev2_pop, by='county_id'))

## previous version
prev_pop_yr <- as.numeric(prev_yr) -2
prev_pop <- dbGetQuery(con2, paste0("SELECT geoid AS county_id, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_", prev_pop_yr, " WHERE geolevel = 'county'"))
prev_index_pop_tables <- lapply(prev_index_tables, function(x) x%>% left_join(prev_pop, by='county_id'))

## current version
curr_pop_yr <- as.numeric(curr_yr) -2
curr_pop <- dbGetQuery(con2, paste0("SELECT geoid AS county_id, dp05_0001e FROM demographics.acs_5yr_dp05_multigeo_", curr_pop_yr, " WHERE geolevel = 'county'"))
curr_index_pop_tables <- lapply(curr_index_tables, function(x) x%>% left_join(curr_pop, by='county_id'))


####################### DATA ANALYSIS #####################################
comp_index_list <-do.call(c, Map(list, curr_index_pop_tables[1], prev_index_pop_tables[1], prev2_index_pop_tables[1]))
names(comp_index_list) <- c(paste0("composite_index_", curr_yr), paste0("composite_index_", prev_yr), paste0("composite_index_", prev2_yr))
comp_index_list <- lapply(comp_index_list, transform, quadrant=ifelse(quadrant == "green", "purple", quadrant)) # update quadrant colors to match current colors

# Remove counties without quadrant values. Cap composite index perf/disp z-scores at 1 and -1. More info: https://catalystcalifornia.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
# set chart colors
hex_code <- c("#81007F", "#FADA5E", "#FA8128", "#CA3433")
quadrant <- c("purple", "yellow", "orange", "red")
quadrant_hex <- data.frame(hex_code, quadrant)

comp_index_list <- lapply(comp_index_list, function(x) x %>% mutate(
    disp_z_cap = case_when(
      disparity_z > 1 ~ 1,
      disparity_z < -1 ~ -1,
      TRUE ~ disparity_z)
    ) %>% mutate (
    perf_z_cap = case_when(
      performance_z > 1 ~ 1,
      performance_z < -1 ~ -1,
      TRUE ~ performance_z)
    ) %>% left_join(
    quadrant_hex, by='quadrant'
    ) %>% filter(
    quadrant %in% c("purple", "yellow", "orange", "red")))

comp_index_list <- listr::list_rename(comp_index_list, 'prev2_index' = paste0("composite_index_", prev2_yr), 'prev_index' = paste0("composite_index_", prev_yr), 'curr_index' = paste0("composite_index_", curr_yr))  # rename list elements to generic names

list2env(comp_index_list, envir = .GlobalEnv)

# list of low pop counties in RED quadrant in prev2 - curr yrs
small_pop <- lapply(comp_index_list, function(x) filter(x, dp05_0001e < 100000))
small_pop <- listr::list_rename(small_pop, 'prev2' = prev2_index, 'prev' = prev_index, 'curr' = curr_index)  # rename list elements to generic names

prev2_small_pop <- do.call(rbind, small_pop['prev2']) %>% select(county_name, county_id, quadrant) %>% rename("prev2_quadrant" = quadrant)
prev_small_pop <- do.call(rbind, small_pop['prev']) %>% select(county_name, county_id, quadrant) %>% rename("prev_quadrant" = quadrant)
curr_small_pop <- do.call(rbind, small_pop['curr']) %>% select(county_name, county_id, quadrant) %>% rename("curr_quadrant" = quadrant)

small_popall <- prev2_small_pop %>% left_join(prev_small_pop, by=c('county_id', 'county_name'))
small_popall <- small_popall %>% left_join(curr_small_pop, by=c('county_id', 'county_name'))
small_popall <- small_popall %>% rename("County" = county_name, "County ID" = county_id)
small_popall <- small_popall %>% as.data.frame() %>% arrange(County) %>% select(-c("County ID"))
#red_small_pop <- lapply(comp_index_list, function(x) filter(x, quadrant == "red" & dp05_0001e < 100000))

red_small <- data.frame(c(nrow(small_popall[small_popall$prev2_quadrant == 'red', ]), nrow(small_popall[small_popall$prev_quadrant == 'red', ]), nrow(small_popall[small_popall$curr_quadrant == 'red', ])))
RC_Version_Year <- data.frame(c(yr = c(prev2_yr, prev_yr, curr_yr)))

small_popall_summary <- data.frame(c(RC_Version_Year, red_small))
names(small_popall_summary)[1] <- "RC_Year"
names(small_popall_summary)[2] <- "num_counties"

# join curr/prev2 z-scores for potential further analysis
z_scores <- data.frame(prev2_index_pop_tables[1]) 
colnames(z_scores) = gsub(paste0("arei_composite_index_", prev2_yr, "."), "", colnames(z_scores))
z_scores <- z_scores %>% select(c(county_name, dp05_0001e, quadrant, ends_with("_z")))
#z_scores <- z_scores %>% left_join(composite_index_2024 %>% select(county_name, ends_with("_z")), by = "county_name", suffix=c(".v5", ".v6"))
z_scores <- z_scores %>% left_join(do.call(rbind, curr_index_pop_tables[1]) %>% select(county_name, ends_with("_z")), by = "county_name", suffix=c(prev2_schema, curr_schema))


```

<!-- *** -->
# Summary
Looking at the composite index in `r curr_yr`, there were `r small_popall_summary %>% filter(RC_Year == curr_yr) %>% select(num_counties)` (out of `r nrow(curr_small_pop)`) counties with populations smaller than 100k (smaller pop counties) in the Red Quadrant. That number was `r small_popall_summary %>% filter(RC_Year == prev_yr) %>% select(num_counties)` (out of `r nrow(prev_small_pop)`) last year and two years ago there were `r small_popall_summary %>% filter(RC_Year == prev2_yr) %>% select(num_counties)` (out of `r nrow(prev2_small_pop)`). 

NEED TO UPDATE THE REST OF THIS CHUNK: Behind that increase is the fact that 5 small pop counties (Colusa, Inyo, Plumas, Sutter, Tehama) moved into the Red Quadrant, while one (Mariposa) moved from Red into the Yellow Quadrant.

Looking at current year issue area indexes, we can see that there are many smaller pop counties in the Red Quadrant for Economic Opportunity and Democracy.

Note: All smaller population counties are in the Northern / Sierra region, except for San Benito in the Central Coast region.

# Data

## Composite Index 
```{r sm county summary}

library(kableExtra)
small_popall_summary_sort <- small_popall_summary %>% arrange((RC_Year), descending = FALSE)  

summary <- kable(small_popall_summary_sort, digits=0, col.names=c("RC_Year","# of Small Pop Red Counties")) %>%
  kable_styling()%>%
    row_spec(1, bold = T, color ="white", background="#62bce5", extra_css = "border-bottom: 1px solid")%>%
    row_spec(2:3, bold=T, color= "white", background="#6c90ca", extra_css = "border-bottom: 1px solid")%>%
    add_header_above(c("Number of Counties with <100k Pop in Red Quadrant"=1," "=1), align="l")
summary

```

```{r small counties}
counties <- kable(small_popall, digits=0, col.names=c("County", paste0(prev2_yr,".quadrant"), paste0(prev_yr,".quadrant"), paste0(curr_yr,".quadrant")))%>%
  kable_styling()%>%
    add_header_above(c("Counties with Composite Index Scores and <100K Pop"=1," "=3), align="l") %>% 
  kable_material(c("striped"))
counties
```

```{r scatterplot}

scatterplot <- function(table_name, title) {
scatter_ <- table_name %>%
    hchart("scatter", 
    hcaes(x=disp_z_cap, y=perf_z_cap, size=dp05_0001e, color=hex_code),
      tooltip = 
         list(pointFormat = 
                "<strong>County: </strong>{point.county_name} <br><strong>Outcome Rank: </strong>{point.performance_rank} <br><strong>Disparity Rank: </strong>{point.disparity_rank} <br><strong>Universe: </strong>{point.dp05_0001e:,.0f}")) %>%
  hc_title(text = (paste0("Composite Index ", title))) %>%
  hc_xAxis(title = list(text = "Disparity Z-Score"), max = 1.2, min = -1.2, tickInterval = .5) %>% 
  hc_yAxis(title = list(text = "Outcome Z-Score"), max = 1.2, min = -1.2, tickInterval = .5) %>% 
  hc_caption(
    text = "Data source: Various",
    align = "center"
     ) %>% hc_size(height=700,width=700)

  hc_add_theme(scatter_, rc_theme) 
  scatter_
}


curr_plot <- scatterplot(curr_index, curr_yr)
curr_plot


prev_plot <- scatterplot(prev_index, prev_yr)
prev_plot


prev2_plot <- scatterplot(prev2_index, prev2_yr)
prev2_plot

```
