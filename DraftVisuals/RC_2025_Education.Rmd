---
title: "RACE COUNTS: Education"
author: "Authored by: Catalyst California"
date: "10/9/2025"
output:
  html_document:
    number_sections: no
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes

subtitle: 'Draft Visuals'
---

<style type="text/css">
  h1{
  font-family: Rubik;
  }
  h2{
  font-family: Rubik;
  }
  h3{
  font-family: Rubik;
  }
  a{
  font-family: Rubik;
  }
  ul{
  font-family: Rubik;
  }
  ol{
  font-family: Rubik;
  }
  body{
  font-family: Rubik;
  font-size: 15px;
}
p{
  font-family: Rubik;
  font-size: 15px;
}
body { background-color: #FFFFFF; }

</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

#load the libraries via the below source as well as the credentials and set the theme
source("draft_visual_functions.R")

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

##Add RC theme##
rc_theme # load from the above draft_visual_functions.R script

##### UPDATE EACH YEAR AND FOR EACH ISSUE AREA ####
issue_name <- 'Education' # Issue names: Safety & Justice, Democracy, Economic Opportunity, Education, Healthy Built Environment, Health Care Access, Housing
issue <- 'educ' #Issue: crim, demo, educ, econ, hben, hlth, hous
rc_schema <- 'v7'
rc_yr <- '2025'

```

```{r echo=FALSE, include = FALSE}

####################### GET COUNTY DATA #####################################
county_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%county_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

county_list <- dbGetQuery(con, county_list_query) %>% pull(table_name) 

c_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", county_list), county_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
c_tables <- map2(c_tables, names(c_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
c_tables <- lapply(c_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_county_', rc_yr), '', indicator),
         geolevel = 'county'))

# Get issue index
c_index_z <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_", issue, "_index_", rc_yr)) %>%
  rename(geo_name = county_name)  # make 'name' col generic

####################### POPULATION DATA #####################################
#Get total population
pop <- dbGetQuery(con, paste0("SELECT geoid, total_pop, geolevel FROM ", rc_schema, ".arei_race_multigeo WHERE geolevel = 'county'")) %>% select(-geolevel)

c_index_z <- left_join(c_index_z, pop, by = c("county_id" = "geoid"))

c_tables <- lapply(c_tables, function(x) 
  x %>% left_join(pop, by = c("county_id" = "geoid")))

## Make 'name' col generic
c_tables <- lapply(c_tables, function(x)
  x %>% rename(geo_name = county_name))

####################### GET STATE DATA #####################################
state_list_query <- paste0("SELECT table_name FROM information_schema.tables WHERE table_type='BASE TABLE' AND table_schema='", rc_schema, "' AND table_name LIKE '%state_%", rc_yr, "' AND table_name LIKE '%", issue, "%' AND table_name NOT LIKE '%index%';")

state_list <- dbGetQuery(con, state_list_query) %>% pull(table_name) 

s_tables <- lapply(setNames(paste0("select * from ", rc_schema, ".", state_list), state_list), DBI::dbGetQuery, conn = con)

# create column with indicator name
s_tables <- map2(s_tables, names(s_tables), ~ mutate(.x, indicator = .y)) # create column with indicator name

# clean up and add columns
s_tables <- lapply(s_tables, function(x) x %>% 
  select(-any_of('geolevel'), -ends_with("_pop")) %>%
  mutate(issue = substring(indicator, 6,9),
         indicator = substring(indicator, 11),
         indicator = gsub(paste0('_state_', rc_yr), '', indicator),
         geolevel = 'state'))


##Add 2025 v7 Source Data##
v7_sources <- dbGetQuery(con, paste0("SELECT * FROM ", rc_schema, ".arei_indicator_list_cntyst"))
v7_sources <- v7_sources %>% filter(v7_sources$arei_issue_area==issue_name) %>%
  select(arei_indicator, arei_issue_area, rate_descriptor, bar_chart_header, rate_rounding, methodology, data_source, api_name)


## Join metadata to data
c_tables <- lapply(c_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))
s_tables <- lapply(s_tables, function(x) x %>% left_join(v7_sources, by = c("indicator" = "api_name")))

## Sort Lists so they are in the same order
c_tables <- c_tables[order(names(c_tables))]
s_tables <- s_tables[order(names(s_tables))]

names(c_tables)
names(s_tables)
```

<!-- *** -->
# Introduction
NOTE: The data and findings below are drafts subject to change and some pieces are still in the QA process.

RACE COUNTS provides a 3D view of racial equity:
<br>OUTCOME: How well people are doing. The higher the circle, the better the outcome.
<br>DISPARITY: How racial groups compare to one another. The further right the circle, the greater the differences by race.
<br>IMPACT: The total population. The bigger the circle, the larger the population.

<br><span style="color:purple">Purple</span> counties: Gains at Risk; 
<br><span style="color:orange">Orange</span> counties: Prosperity for the Few;
<br><span style="color:#c9cc14">Yellow</span> counties: Struggling to Prosper;
<br><span style="color:red">Red</span> counties: Stuck and Unequal.


# Race/Ethnicity Notes
<br>1) "Other" race includes those who identify with a race outside of the specifically named categories, such as Asian, White, etc.
<br>2) Race labels for bar charts: The "nh_" prefix signifies that a group is non-Latinx (excludes Latinx).
<br>3) The "twoormor" group represents those who identify as Two or More Races.


# Indicators 

## Education Index - UPDATED
```{r, echo=FALSE}
# Remove counties without quadrant values. Cap index perf/disp z-scores at 2 and -2. More info: https://advancementproject.sharepoint.com/:w:/s/Portal/EX59kBOn8iRNrLuY1Sfk3JABT34dO3sj1j9fwkuUxLqUgQ?e=bGyEaZ
  c_index_z <- c_index_z %>% mutate(arei_issue_area=issue_name)
  c_index_chart <- index_scatterplot(c_index_z, 2)

  c_index_chart
```

* San Francisco has the worst racial disparities, driven by large inequities in chronic absenteeism and graduation rates.
* Most Northern/Sierra counties have lower than average outcomes and lower levels of disparity. 
* Five out of six Southern California counties have higher than average disparities, the exception is San Diego. Imperial is ranked 5th most disparate, and San Bernardino is ranked 6th.


## Chronic Absenteeism - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}

c_1_chart <- county_scatterplot(c_tables[[1]])
c_1_chart
```
* San Francisco County is by far the most racially disparate on chronic absenteeism. Non-Latinx NHPI, Non-Latinx Black, and non-Latinx AIAN students have the highest absenteeism rates, with rates between 58-60%.
* Inyo County has the highest rates of absenteeism, with more than half of students (50.9%) being chronically absent. Non-Latinx Black students are the most likely to be chronically absent (78.3%), a rate 3x higher than that of non-Latinx White students (24.5%).
* Los Angeles County is the third most disparate on this measure because about one in three Black, NHPI, and AIAN students (all non-Latinx) are chronically absent compared to only one in 15 non-Latinx Asian students.

### State Barchart
```{r, echo=FALSE}
  s_1_ <- state_barchart(s_tables[[1]])
  s_1_
``` 
* Statewide, AIAN, Black, and NHPI (all non-Latinx) students have the highest rates ranging from 33% to 32.3% respectively. 
* AIAN, Black, NHPI (all non-Latinx) students are 3.8x more likely to be chronically absent than the group with the lowest (best) rate.

### County Barchart

```{r, echo=FALSE}
c_1_long <- county_barchart(c_tables[[1]]) 
c_1_long

```


## ECE Access - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_2_chart <- county_scatterplot(c_tables[[2]])
c_2_chart
```
* Los Angeles County is the 10th most disparate county for ECE Access, due to low access for Latinx and AIAN children.
* 22.2% of San Bernardino County children ages 0-5 have access to a licensed ECE program, which is a 62.4 percentage point difference from Modoc County (84.6%), the county with the most access (best outcome). 


### State Barchart

```{r, echo=FALSE}
  s_2_ <- state_barchart(s_tables[[2]])
  s_2_
``` 
* ECE access rates are low across the state and for all groups, even the best rate means less than one in two children has access. Still Latinx, non-Latinx AIAN and non-Latinx Black children all have less ECE access than the state average.

### County Barchart

```{r, echo=FALSE}
c_6_long <- county_barchart(c_tables[[2]]) 
c_6_long
```


## Third Grade English Proficiency - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_3_chart <- county_scatterplot(c_tables[[3]])
c_3_chart
```
* Mono County is the most disparate in this measure, with a 39 percentage point difference between the groups with the highest and lowest rates. 
* Del Norte County has the worst outcome on this measure with only one in five third graders being proficient in ELA, it is also the fourth most disparate county.
* There seems to be some relationship between less disparity and better outcomes.
 

### State Barchart

```{r, echo=FALSE}
  s_3_ <- state_barchart(s_tables[[3]])
  s_3_
``` 
* Statewide, two groups emerge. In the first group, about one in three non-Latinx Black, non-Latinx AIAN, Latinx, and non-Latinx NHPI students scored proficient. While in the second group, more than 50% of Asian, Filipinx, Two or More Races, and White (all non-Latinx) third graders scored proficient in English Language Arts. 
* Overall, the results are poor. Fewer than half (42.8%) of California students were proficient.

### County Barchart

```{r, echo=FALSE}
c_3_long <- county_barchart(c_tables[[3]]) 
c_3_long
```


## Third Grade Math Proficiency - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_4_chart <- county_scatterplot(c_tables[[4]])
c_4_chart
```
* Del Norte County has the worst outcome on this measure with only one in five students scoring Proficient or Better in Math.
* Larger population counties have above average levels of racial disparities among racial and ethnic groups for this indicator.
* Five of the top 10 counties with the best outcomes are in the Bay Area, some have better than average disparity while others have worse.

### State Barchart

```{r, echo=FALSE}
  s_4_ <- state_barchart(s_tables[[4]])
  s_4_
```
* Statewide, two groups emerge. In the first group, about one in three Black, AIAN, NHPI (all non-Latinx), and Latinx students scored proficient. While in the second group, more than 50% of Asian, Filipinx, White, and Multiracial (all non-Latinx) third graders scored proficient in math. 

### County Barchart

```{r, echo=FALSE}
c_4_long <- county_barchart(c_tables[[4]]) 
c_4_long
```


## High School Graduation - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_5_chart <- county_scatterplot(c_tables[[5]])
c_5_chart
```
* There seems to be a relationship between less racial disparity and better outcomes on high school graduation.
* Nevada, San Francisco, Mono, and Inyo counties have the worst (lowest) graduation rates and the worst racial disparities on this measure. 
* In Nevada County, only one in four Latinx and one in three non-Latinx Black students graduate.

### State Barchart
```{r, echo=FALSE}
  s_5_ <- state_barchart(s_tables[[5]])
  s_5_

```
* Statewide, about one in five non-Latinx Black and non-Latinx AIAN students does not graduate from high school.
* Filipinx, Asian, White, and Multiracial (all non-Latinx) students are more likely to graduate than the average California student.

### County Barchart

```{r, echo=FALSE}
c_5_long <- county_barchart(c_tables[[5]]) 
c_5_long

```



## Diversity of Teachers  - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_6_chart <- county_scatterplot(c_tables[[6]])
c_6_chart
```
* Larger population counties overall are in the Yellow (Lower disparity, Lower outcome) and Red Quadrants (Higher disparity, Lower outcome), with Low Angeles County having the lowest disparity. Note: For this indicator, outcome represents the overall staff:student ratio.
* In LA County, Latinx and Multiracial students are the only groups with below average levels of representation.


### State Barchart

```{r, echo=FALSE}
  s_6_ <- state_barchart(s_tables[[6]])
  s_6_
``` 
* White students have by far the highest representation, with more than 16 White teachers and staff per 100 White students. Compare this to NH-AIANs, the group with the next highest rate, at 7.9 per 100 students.

### County Barchart

```{r, echo=FALSE}
c_6_long <- county_barchart(c_tables[[6]]) 
c_6_long
```


## Suspensions - UPDATED {.tabset .tabset-fade}

### Scatterplot

```{r, echo=FALSE}
c_7_chart <- county_scatterplot(c_tables[[7]])
c_7_chart
```
* Santa Cruz is by far the most disparate county because of high suspension rates for Black and NHPI students (both non-Latinx).
* Los Angeles County has the second best outcome (meaning second lowest overall suspension rate) in the state at 1.9%. However, the Black and AIAN (both non-Latinx) rates are much higher at 5.6% and 3.8% respectively.
* Three counties (Lake, Modoc, and Del Norte) in the Northern/Sierra region have the lowest outcomes (highest rates), with suspension rates between 8-9%. 


### State Barchart

```{r, echo=FALSE}
  s_7_ <- state_barchart(s_tables[[7]])
  s_7_
```
* Black, AIAN, NHPI (all non-Latinx), and Latinx students are more likely to be suspended than the average student in California. 
* School administrators are 7.8x more likely to suspend non-Latinx Black students than the group with the lowest suspension rate. 

### County Barchart

```{r, echo=FALSE}
c_7_long <- county_barchart(c_tables[[7]]) 
c_7_long
```

```{r, include=FALSE}
##Disconnect from db
dbDisconnect(con)
dbDisconnect(con2)

```


```{r echo=FALSE, include = FALSE}
# below is a javascript chunk for the county bar-charts. The chunk automatically selects the 'Alameda' county as the first chunk. Without the chunk below, as you can see from the output above, the first bar-chart shown sums the race/ethnicity rates for all of the counties. 
# Each line that starts with document is for each graph (0-6) for a total of 7 graphs. If another graph is added, then you would simply add another line and label it as [6]. 

# Notice that it isn't an R chunk, it is a JS chunk. :) 
```


```{js}
function filter_default() {
    document.getElementsByClassName("selectized") 
[0].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[1].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[2].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[3].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[4].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[5].selectize.setValue("Alameda", false);

 document.getElementsByClassName("selectized") 
[6].selectize.setValue("Alameda", false);

 }
window.onload = filter_default;
```
